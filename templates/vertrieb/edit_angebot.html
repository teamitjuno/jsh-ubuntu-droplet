{% extends 'vertrieb/base.html' %}
{% load static %}
{% load i18n %}
{% load widget_tweaks %}
{% block content %}
{% load custom_filter %}

<div class="content-page">
    <div class="content">
        {% if vertrieb_angebot.angebot_id %}
            {% if not vertrieb_angebot.is_locked and vertrieb_angebot.status != "angenommen" %}
        <form class="needs-validation" novalidate id="main-form" method="POST" action="{% url 'vertrieb_interface:edit_angebot' angebot_id=vertrieb_angebot.angebot_id %}">
            {% csrf_token %}
                <div class="container-fluid">
                {% if form.errors %}
                    <div class="row">
                        <div class="col-xl-12">
                            <div class="card m-3">
                                <div class="card-body border-primary border">     
                                    <div class="alert alert-danger">Bitte beachten Sie, dass die folgenden Felder für die PDF-Erstellung erforderlich sind::
                                        <ul>
                                            {% for field in form %}
                                                {% if field.errors %}
                                                    <li>{{ field.label }} - {{ field.errors.0 }}</li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %} 

                    <div class="row">
                        <div class="col-12">
                            <div class="page-title-box">
                                <div class="page-title-right"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xl-12">
                            <div class="card">
                                <div class="card-body border-primary border">
                                        <ul class="nav nav-tabs nav-justified nav-bordered mb-4" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <a href="#info" data-bs-toggle="tab" aria-expanded="true" class="nav-link active" aria-selected="fakse" role="tab">
                                                    <i class="mdi mdi-home-variant d-md-none d-block"></i>
                                                    <span class="d-none d-md-block h4">Info</span>
                                                </a>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <a href="#module" onclick=toggleActiveTabFeature() data-bs-toggle="tab" aria-expanded="true" class="nav-link" aria-selected="true" tabindex="-1" role="tab">
                                                    <i class="mdi mdi-panorama-sphere-outline d-md-none d-block"></i>
                                                    <span class="d-none d-md-block h4">Module & Zubehör</span>
                                                </a>
                                            </li>
                                            {% if vertrieb_angebot.status == "angenommen" %}
                                            <li hidden class="nav-item" role="presentation">
                                                <a href="#ticket" data-bs-toggle="tab" aria-expanded="true" class="nav-link" aria-selected="false" tabindex="-1" role="tab">
                                                    <i class="mdi mdi-altimeter d-md-none d-block"></i>
                                                    <span class="d-none d-md-block h4">Ticket</span>
                                                </a>
                                            </li>
                                            {% endif %}
                                            <li class="nav-item" role="presentation">
                                                <a href="#kalkulationen" data-bs-toggle="tab" aria-expanded="true" class="nav-link " aria-selected="false" tabindex="-1" role="tab">
                                                    <i class="mdi mdi-application-brackets-outline d-md-none d-block"></i>
                                                    <span class="d-none d-md-block h4">Kalkulationen</span>
                                                </a>
                                            </li>
                                        </ul>
                                    <div class="tab-content">
                                        <div class="tab-pane show active" id="info" role="presentation">
                                            <div class="card-body">
                                                <div class="row">
                                                    <!-- Column 1 -->
                                                    <div class="col-lg-5">
                                                        <div class="card mb-3">
                                                        <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Interessenteninfo</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tbody>
                                                                        <tr hidden>
                                                                            <th></th>
                                                                            <td hidden>
                                                                                <div class="custom-control custom-switch">
                                                                                    <input type="checkbox" class="custom-control-input" id="switch10" {% if form.is_locked.value %}checked{% endif %} data-switch="success" name="{{ form.is_locked.html_name }}"/>
                                                                                    <label class="custom-control-label" for="switch10" data-on-label="Yes" data-off-label="No"></label>
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                        <tr hidden>
                                                                            <th>{{ form.zoho_id.label_tag }}</th>
                                                                            <td>{{ form.zoho_id }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.name.label_tag }}</th>
                                                                            <td>
                                                                                {{ form.name }}
                                                                                <div class="invalid-tooltip">
                                                                                    Wählen Sie einen Interessent
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.anrede.label_tag }}</th>
                                                                            <td> {{ form.anrede }}
                                                                                
                                                                            </td>
                                                                        </tr>
                                                                        <tr hidden>
                                                                            <th>{{ form.vorname_nachname.label_tag }}</th>
                                                                            <td>{{ form.vorname_nachname }}
                                                                                
                                                                            </td>
                                                                        </tr>
                                                                        <tr hidden>
                                                                            <th>{{ form.name_suffix.label_tag }}</th>
                                                                            <td>{{ form.name_suffix }}
                                                                                
                                                                            </td>
                                                                        </tr>
                                                                        <tr id="tr_first_name">
                                                                            <th>{{ form.zoho_first_name.label_tag }}</th>
                                                                            <td>{{ form.zoho_first_name }}
                                                                                
                                                                            </td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.zoho_last_name.label_tag }}</th>
                                                                            <td>{{ form.zoho_last_name }}
                                                                                
                                                                            </td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.telefon_mobil.label_tag }}</th>
                                                                            <td>{{ form.telefon_mobil }}
                                                                               
                                                                            </td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.telefon_festnetz.label_tag }}</th>
                                                                            <td>{{ form.telefon_festnetz }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.email.label_tag }}</th>
                                                                            <td>{{ form.email }}
                                                                                
                                                                            </td>
                                                                        </tr>
                                                                        <tr hidden>
                                                                            <th>{{ form.firma.label_tag }}</th>
                                                                            <td>{{ form.firma }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.strasse.label_tag }}</th>
                                                                            <td>{{ form.strasse }}
                                                                           
                                                                            </td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.ort.label_tag }}</th>
                                                                            <td>{{ form.ort }}
                                                                            
                                                                            </td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.anlagenstandort.label_tag }}</th>
                                                                            <td>{{ form.anlagenstandort }}</td>
                                                                            
                                                                            <td hidden><input type="text" id="longitude" name="postanschrift_longitude" value="{{ form.postanschrift_longitude.value }}"></td>
                                                                            <td hidden><input type="text" id="latitude" name="postanschrift_latitude" value="{{ form.postanschrift_latitude.value }}"></td>
                                                                            


                                                                        </tr>
                                                                        
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                        <!-- Column 2 -->
                                                        {% if user.map_notizen_container_view == "Map" %}
                                                    <div class="col-lg-7">

                                                        <div class="card">
                                                            <div class="col-sm-12 mb-2 mb-sm-0">             
                                                                
                                                                <ul class="nav nav-tabs nav-bordered mb-3">
                                                                    <li class="nav-item">
                                                                        <a href="#home-b1" data-bs-toggle="tab" aria-expanded="true" class="nav-link active">
                                                                            <i class="mdi mdi-home-variant d-md-none d-block"></i>
                                                                            <span class="d-none d-md-block">Map</span>
                                                                        </a>
                                                                    </li>
                                                                    <li class="nav-item">
                                                                        <a href="#profile-b1" data-bs-toggle="tab" aria-expanded="true" class="nav-link">
                                                                            <i class="mdi mdi-account-circle d-md-none d-block"></i>
                                                                            <span class="d-none d-md-block">Notizen</span>
                                                                        </a>
                                                                    </li>
                                                                    {% comment %} <li class="nav-item">
                                                                        <a href="#settings-b1" data-bs-toggle="tab" aria-expanded="false" class="nav-link">
                                                                            <i class="mdi mdi-settings-outline d-md-none d-block"></i>
                                                                            <span class="d-none d-md-block">FAQ</span>
                                                                        </a>
                                                                    </li>
                                                                    <li class="nav-item">
                                                                        <a href="#abdeckung-b1" data-bs-toggle="tab" aria-expanded="false" class="nav-link">
                                                                            <i class="mdi mdi-settings-outline d-md-none d-block"></i>
                                                                            <span class="d-none d-md-block">Abdeckung</span>
                                                                        </a>
                                                                    </li> {% endcomment %}
                                                                </ul>
                                                                
                                                                    <div class="tab-content">
                                                                        <!-- Tab Map OpenStreet -->
                                                                        <div class="tab-pane show active" id="home-b1">
                                                                            <div id="map" style="width: 100%; height: 550px;"></div>
                                                                            <a id="dynamicMapLink" href="#" target="_blank">Größere Karte anzeigen</a>
                                                                            <br/>
                                                                        </div>
                                                                        <!-- Tab Map SolarApi -->
                                                                        <div class="tab-pane" id="profile-b1">
                                                                            {% include 'vertrieb/extra/notizen.html' %}
                                                                        </div>
                                                                        <!-- Tab Map FAQ -->
                                                                        <div class="tab-pane" id="settings-b1">
                                                                            <div class="card mb-3">
                                                                                <div class="col-sm-12">
                                                                                    <div class="text-center">
                                                                                        <h3 class="">FAQ: Verständnis der zweiten Registerkarte der Solar-API</h3>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="card-body">
                                                                                    <div class="col-xl-12">
                                                                                        <div>
                                                                                            <div class="faq-question-q-box">Q.</div>
                                                                                            <h4 class="faq-question">Was ermöglicht die zweite Registerkarte der Solar-API?</h4>
                                                                                            <p class="faq-answer mb-4">Die zweite Registerkarte der Solar-API ist eine neu entwickelte Funktion, die die Visualisierung potenzieller Standorte für Solarpanel-Installationen auf dynamischen Karten ermöglicht. Sie nutzt "Building Insights" in der Solar-API und befindet sich aktuell noch im Testmodus, ist jedoch bereits nutzbar.</p>
                                                                                        </div>

                                                                                        <!-- Question/Answer -->
                                                                                        <div>
                                                                                            <div class="faq-question-q-box">Q.</div>
                                                                                            <h4 class="faq-question">Gibt es geografische Einschränkungen bei der Datenabdeckung?</h4>
                                                                                            <p class="faq-answer mb-4">Ja, die Abdeckung der Google-Gebäudedaten, die für diese Funktion notwendig sind, ist derzeit auf bestimmte Regionen beschränkt. Eine ungefähre Übersicht der Abdeckung  <a href="https://developers.google.com/maps/documentation/solar/coverage" target="_blank">finden Sie hier</a> oder sich im Tab "Abdeckung" informieren.</p>
                                                                                        </div>

                                                                                        <!-- Question/Answer -->
                                                                                        <div>
                                                                                            <div class="faq-question-q-box">Q.</div>
                                                                                            <h4 class="faq-question">Was bietet die Solar-API außer der Standortvisualisierung noch?</h4>
                                                                                            <p class="faq-answer mb-4">Die Solar-API stellt umfassende Daten zu Energieeinsparungen und zur Planung von Solaranlagen zur Verfügung. Diese Daten helfen dabei, das Solarpotenzial besser zu verstehen und zu nutzen, auch wenn man selbst nicht tief in der Materie steckt.</p>
                                                                                        </div>

                                                                                        <!-- Question/Answer -->
                                                                                        <div>
                                                                                            <div class="faq-question-q-box">Q.</div>
                                                                                            <h4 class="faq-question">Wie kann die Solar-API-Demo genutzt werden?</h4>
                                                                                            <p class="faq-answer mb-4">Um die Demo zu nutzen, geben Sie einfach die gewünschte Adresse in die Suchleiste unter der Registerkarte "Solar-API" ein und verwenden Sie den Schieberegler, um die Anzahl der Module zu variieren.</p>
                                                                                        </div>
                                                                                        
                                                                                    </div> <!-- end col-->
                                                                                </div>
                                                                            </div>
                                                                        </div> <!-- end tab-content-->

                                                                        <!-- Tab Abdeckung -->
                                                                        <div class="tab-pane" id="abdeckung-b1">
                                                                            <img class="img-fluid" src="{% static 'img/abdeckung.png' %}" width="100%" height="250px" alt="Card image cap">
                                                                        </div>
                                                                    </div> <!-- end col-->
                                                            
                                                            </div>
                                                        </div>
                                                    </div>
                                            
                                                        {% elif user.map_notizen_container_view == "Notizen" %}
                                                            {% include 'vertrieb/extra/notizen.html' %}
                                                        {% endif %}
                                                </div><!-- End of row -->
                                            </div>
                                        </div>
                                        <div class="tab-pane" id="module" role="presentation">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-lg-3">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Wechselrichter & Speicher</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tr>
                                                                        <th>{{ form.hersteller.label_tag }}</th>
                                                                        <td>{{ form.hersteller }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.wechselrichter_model.label_tag }}</th>
                                                                        <td>
                                                                            {{ form.wechselrichter_model }}
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.speicher_model.label_tag }}</th>
                                                                        <td>{{ form.speicher_model }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.anz_speicher.label_tag }}</th>
                                                                        <td>{{ form.anz_speicher }}</td>
                                                                        
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.gesamtkapazitat.label_tag }}kWh</th>
                                                                        <td><input type="text" readonly class="form-control-plaintext" id="gesamtkapazitat" value="{{ form.gesamtkapazitat.value }}"></td>
                                                                        
                                                                        
                                                                    </tr>
                                                                </table>
                                                            </div>
                                                        </div>

                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Gesamtpreis PV-Anlage (inkl. Monatge)</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tr>
                                                                        <th>Preis Netto</th>
                                                                        <td class="text-success-emphasis">{{ vertrieb_angebot.angebotsumme|format_price }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Preis Brutto</th>
                                                                        <td class="text-success-emphasis">{{ vertrieb_angebot.angebotsumme|format_price }}</td>
                                                                    </tr>
                                                                </table>
                                                               
                                                                <button type="submit" onclick=submitFormWithAction('angebotsumme_rechnen') class="btn btn-soft-info rounded-pill">Angebot Summe rechnen</button>
                                                                

                                                            </div>
                                                        </div>
                                                    </div> 
                                                    <div class="col-lg-3">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Module</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tr>
                                                                        <th>{{ form.solar_module.label_tag }}</th>
                                                                        <td>{{ form.solar_module }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.modulanzahl.label_tag }}</th>
                                                                        <td id="modulanzahl" name="modulanzahl" data-bs-toggle="tooltip">
                                                                            {{ form.modulanzahl }}
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.garantieWR.label_tag }}</th>
                                                                        <td>{{ form.garantieWR }}</td>
                                                                    </tr>
                                                                    <tr hidden>
                                                                        <th>{{ form.eddi.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="switch03" {% if form.eddi.value %}checked{% endif %} data-switch="success" name="{{ form.eddi.html_name }}" />
                                                                                <label class="custom-control-label" for="switch03" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    
                                                                    <tr>
                                                                        <th>{{ form.notstrom.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="switch04" {% if form.notstrom.value %}checked{% endif %} data-switch="success" name="{{ form.notstrom.html_name }}" />
                                                                                <label class="custom-control-label" for="switch04" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    
                                                                    
                                                                    <tr>
                                                                        <th>{{ form.anzOptimizer.label_tag }}</th>
                                                                        <td id="anzOptimizer" name="anzOptimizer" data-bs-toggle="tooltip">
                                                                            {{ form.anzOptimizer }}
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Modulleistung [Wp]</th>
                                                                        <td id="modulleistungWp" name="modulleistungWp">{{ vertrieb_angebot.modulleistungWp }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Modullsumme [kWp]</th>
                                                                        <td id="modulsumme_kWp" name="modulsumme_kWp">{{ vertrieb_angebot.modulsumme_kWp }}</td>
                                                                    </tr>
                                                                </table>
                                                                <table class="table table-sm table-hover">
                                                                    <tr>
                                                                        <th>Zahlungsmodalitäten</th>
                                                                        <td>{{ form.zahlungsbedingungen }}</td>
                                                                    </tr>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Zubehör</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tbody>
                                                                        {% include 'vertrieb/extra/wand_content.html' %}
                                                                        {% include 'vertrieb/extra/elwa_2_content.html' %}
                                                                        {% include 'vertrieb/extra/thor_2_content.html' %}
                                                                        {% include 'vertrieb/extra/wallbox_content.html' %}
                                                                        {% include 'vertrieb/extra/komplex_content.html' %}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Energie Details</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tr>
                                                                        <th>Erzeugte Energie pro Jahr [kWh]</th>
                                                                        <td>{{ vertrieb_angebot.erzeugte_energie_pro_jahr|format_number }} </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Nutzbare PV-Energie [kWh]</th>
                                                                        <td>{{ vertrieb_angebot.nutzbare_nutzenergie|format_number }} </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Benögte Restenegie [kWh]</th>
                                                                        <td>{{ vertrieb_angebot.benotigte_restenergie|format_number }} </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>kosten für Restenegie [€]</th>
                                                                        <td>{{ vertrieb_angebot.kosten_fur_restenergie|format_price }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Einspreisevergütung gesamt [€]</th>
                                                                        <td>{{ vertrieb_angebot.einspreisevergütung_gesamt|format_price }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Stromkosten ohne PV-Anlage [€]</th>
                                                                        <td>{{ vertrieb_angebot.strom_ohne|format_price }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Preis abzgl Vergütung und inkl. Restrom [€]</th>
                                                                        <td>{{ vertrieb_angebot.abzug_vergutung|format_price }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Ersparnis [€]</th>
                                                                        <td>{{ vertrieb_angebot.Ersparnis|format_price }}</td>
                                                                    </tr>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row"> 
                                                    {% if user.role.name == "admin" %}
                                                    <div class="col-lg-3">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Individual Preis</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tr>
                                                                        <th>{{ form.indiv_price_included.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="switch_indiv_price_included" {% if form.indiv_price_included.value %}checked{% endif %} data-switch="success" name="{{ form.indiv_price_included.html_name }}" />
                                                                                <label class="custom-control-label" for="switch_indiv_price_included" data-on-label="Yes" data-off-label="No"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr id="indiv_price_row">
                                                                        <th>{{form.indiv_price.label_tag }}</th>
                                                                        <td>{{ form.indiv_price }}</td>
                                                                    </tr>
                                                                </table>
                                                                <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
                                                                <script type="text/javascript">
                                                                    $(document).ready(function() {
                                                                        // Initial state of 'Inddiv Preis' row
                                                                        updateIndivPreisRow();
                                                                        // On 'Indiv Preis inkl.' checkbox state change
                                                                        $('#switch_indiv_price_included').change(function() {
                                                                            updateIndivPreisRow();
                                                                        });
                                                                        function updateIndivPreisRow() {
                                                                            if ($('#switch_indiv_price_included').is(':checked')) {
                                                                                // If checkbox is checked, show 'Inddiv Preis' row
                                                                                $('#indiv_price_row').show();
                                                                            } else {
                                                                                // If checkbox is not checked, hide 'Inddiv Preis' row
                                                                                $('#indiv_price_row').hide();
                                                                            }
                                                                        }
                                                                    });
                                                                </script>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div> 
                                            </div>
                                        </div>
                                        {% if vertrieb_angebot.status == "angenommen" %}
                                        <div hidden class="tab-pane" id="ticket" role="presentation">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-lg-5">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 bg-opacity-75 bg-gradient text-white">Solar Module & Anzahl </div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tbody>
                                                                        <tr>
                                                                            <th>{{ form.solar_module.label_tag }}</th>
                                                                            <td>{{ form.module_ticket }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.modul_anzahl_ticket.label_tag }}</th>
                                                                            <td>{{ form.modul_anzahl_ticket }}</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-4">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 bg-opacity-75 bg-gradient text-white">Zusätzlich & Abzüge:</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tbody>
                                                                        <tr>
                                                                            <th>{{ form.optimizer_ticket.label_tag }}</th>
                                                                            <td>{{ form.optimizer_ticket }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.batteriemodule_ticket.label_tag }}</th>
                                                                            <td>{{ form.batteriemodule_ticket }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.notstrom_ticket.label_tag }}</th>
                                                                            <td>{{ form.notstrom_ticket }}</td>
                                                                        </tr>
                                                                        <tr hidden>
                                                                            <th>{{ form.eddi_ticket.label_tag }}</th>
                                                                            <td>{{ form.eddi_ticket }}</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                
                                                    <div class="col-lg-3">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 bg-opacity-75 bg-gradient text-white">Ticket Preis</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tbody>
                                                                        <tr>
                                                                            <th>Gesamtticketpreis Netto</th>
                                                                            <td>{{ vertrieb_angebot.Full_ticket_preis }} €</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>Gesamtticketpreis Brutto</th>
                                                                            <td>{{ vertrieb_angebot.Full_ticket_preis }} €</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% if vertrieb_angebot.angebot_id_assigned %}
                                                    <div class="col-lg-3">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Pdf-Erstellung verfügbar</div>
                                                            <div class="card-body">
                                                                
                                                                <a href="{% url 'vertrieb_interface:create_ticket_pdf' vertrieb_angebot.angebot_id %}" class="btn btn-outline-info rounded-pill">PDF-Ticket Erstellen</a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}                        
                                        <div class="tab-pane" id="kalkulationen" role="presentation">                       
                                            <div class="card-body">
                                                <div class="row">

                                                    <div class="col-lg-4">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Kalkulation Info</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tbody>
                                                                        <tr>
                                                                            <th>{{ form.verbrauch.label_tag }}</th>
                                                                            <td>{{ form.verbrauch }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.grundpreis.label_tag }}</th>
                                                                            <td>{{ form.grundpreis }}</td> 
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.arbeitspreis.label_tag }}</th>
                                                                            <td id="arbeitspreis" name="arbeitspreis">{{ form.arbeitspreis }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.prognose.label_tag }}</th>
                                                                            <td>{{ form.prognose }}</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Pdf-Erstellung verfügbar</div>
                                                            <div class="card-body">
                                                                <button type="submit" onclick=submitFormWithAction('kalkulation_erstellen') class="btn btn-outline-info rounded-pill">PDF-Kalkulation erstellen</button>
                                                                {% if vertrieb_angebot.angebot_id_assigned == False %}
                                                                <button type="submit" onclick=submitFormWithAction('angebotsumme_rechnen') class="btn btn-outline-info rounded-pill">Kalkulation rechnen</button>
                                                                {% else %}
                                                                <button type="submit" onclick=submitFormWithAction('angebotsumme_rechnen') class="btn btn-outline-info rounded-pill">Kalkulation rechnen</button>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="col-lg-4">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Kalkulation Info</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tbody>
                                                                        <tr>
                                                                            <th>{{ form.bis10kWp.label_tag }} </th>
                                                                            <td>{{ form.bis10kWp }} </td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.bis40kWp.label_tag }} </th>
                                                                            <td>{{ form.bis40kWp }} </td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.zeitraum.label_tag }}</th>
                                                                            <td>{{ form.zeitraum }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.ausrichtung.label_tag }}</th>
                                                                            <td>{{ form.ausrichtung }}</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                        
                                                    </div>
                                                    <div class="col-lg-4">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Energy Details</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tr>
                                                                        <th>Erzeugte Energie pro Jahr [kWh]</th>
                                                                        <td>{{ vertrieb_angebot.erzeugte_energie_pro_jahr|format_number }} kWh</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Nutzbare PV-Energie [kWh]</th>
                                                                        <td>{{ vertrieb_angebot.nutzbare_nutzenergie|format_number }} kWh</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Benögte Restenegie [kWh]</th>
                                                                        <td>{{ vertrieb_angebot.benotigte_restenergie|format_number }} kWh</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>kosten für Restenegie</th>
                                                                        <td>{{ vertrieb_angebot.kosten_fur_restenergie|format_price }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Einspreisevergütung gesamt [€]</th>
                                                                        <td>{{ vertrieb_angebot.einspreisevergütung_gesamt|format_price }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Stromkosten ohne PV-Anlage</th>
                                                                        <td>{{ vertrieb_angebot.strom_ohne|format_price }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Preis abzgl Vergütung und inkl. Restrom</th>
                                                                        <td>{{ vertrieb_angebot.abzug_vergutung|format_price }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Ersparnis [€]</th>
                                                                        <td>{{ vertrieb_angebot.Ersparnis|format_price }}</td>
                                                                    </tr>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xxl-4">
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="card widget-flat">
                                        <div class="card-body border-info border">
                                            <div class="float-end">
                                                <i class="mdi mdi-file-document widget-icon"></i>
                                            </div>
                                            <h5 class="text-muted fw-normal mt-0" title="Number of Customers">Angebot ID</h5>
                                            {% if vertrieb_angebot.angebot_id_assigned %}
                                                <h3 class="mt-3 mb-3">{{ vertrieb_angebot.angebot_id}}</h3>
                                            {% else %}
                                                <h3 class="mt-3 mb-3">Noch nicht zugeordnet</h3>
                                            {% endif %}
                                            {% if vertrieb_angebot.countdown %}
                                            <span class="text-nowrap h4"> läuft in  </span><span class="text-danger me-2 text-nowrap h4">{{ vertrieb_angebot.countdown }}</span><span class="text-nowrap h4"> ab.</span>
                                            <p></p>
                                            {% endif %}
                                            <p class="mb-0 text-muted">
                                                {% if not vertrieb_angebot.is_locked %}
                                                    <span class="text-success me-2"></i> Verfügbar</span>
                                                {% else %}
                                                    <span class="text-danger me-2"></i> Nicht verfügbar</span>
                                                {% endif %}    
                                                    <span class="text-nowrap">Zugriff auf die Bearbeitung</span>  
                                            </p>
                                        </div> 
                                    </div> 
                                </div> 
                                <div class="col-sm-6">
                                    <div class="card widget-flat">
                                        <div class="card-body border-info border">
                                            <div class="float-end">
                                                <i class="mdi mdi-account widget-icon"></i>
                                            </div>
                                            <h5 class="text-muted fw-normal mt-0" title="Number of Orders">Kundennumer</h5>
                                            <input type="text" readonly class="form-control-plaintext h2" id="zoho_kundennumer" value="{{ vertrieb_angebot.zoho_kundennumer }}">
                                            {% comment %} <p>{{ vertrieb_angebot.zoho_kundennumer}}</p> {% endcomment %}
                                            {% comment %} <p hidden>{{ form.zoho_kundennumer}}</p>  {% endcomment %}
                                            
                                            <p class="mb-0 text-muted">
                                            {% if not vertrieb_angebot.termine_text %}
                                                <span class="text-danger me-2"></i> Kein Termin</span>
                                            {% else %}
                                                <span class="text-success me-2"></i> {{ vertrieb_angebot.termine_text }}</span>
                                            {% endif %}
                                                <span class="text-nowrap">Termin</span>
                                            </p>
                                        </div> 
                                    </div> 
                                </div> 
                            </div> 
                            <div class="row">
                                <div hidden class="col-sm-6">
                                    <div class="card widget-flat">
                                        <div class="card-body">
                                            {% if vertrieb_angebot.status == 'bekommen' %} 
                                            <div class="float-end">
                                                <button name="change_status_button" id="changeStatusButton" class="btn btn-soft-success rounded-pill" type="submit">finalisieren</button>
                                            </div>
                                            {% endif %}
                                            <h5 class="text-muted fw-normal mt-0" title="Number of Orders">{{ vertrieb_angebot.anfrage_vom }}</h5>
                                            <p></p>
                                            {% if not vertrieb_angebot.is_locked %}
                                                <h4 class="text-muted fw-normal mt-0" title="Number of Orders">{{ form.status.label_tag}}:</h4>
                                                <h4 hidden>{{ form.status }}</h4>
                                                <input type="text" readonly class="form-control-plaintext h2" id="id_status" value="{{ form.status.value }}">
                                            {% else %}
                                                <h4 class="text-muted fw-normal mt-0" title="Number of Orders">{{ form.status.label_tag}}:</h4>
                                                <h4 hidden>{{ form.status }}</h4>
                                                <input type="text" readonly class="form-control-plaintext h2" id="id_status" value="{{ form.status.value }}">
                                                
                                            {% endif %}
                                            {% if vertrieb_angebot.status == 'bekommen' %} 
                                            <p class="mb-0 text-muted">
                                                    <span class="text-success me-2"></i> {{ vertrieb_angebot.status_change_field }}</span>
                                                    <span class="text-nowrap">Änderungsdatum</span>
                                            </p>
                                            {% endif %}
                                        </div> 
                                    </div> 
                                </div> 

                                <div class="col-sm-6">
                                    <div class="card widget-flat">
                                        <div class="card-body border-info border">
                                         <input type="hidden" name="action_type" id="actionType" value="">
                                                                                                        <script>
                                                            function setActionType(value) {
                                                                document.getElementById('actionType').value = value;
                                                            }
                                                        </script>
                                            <h5 class="text-muted fw-normal mt-0" title="Number of Orders">verfügbare Aktionen:</h5>

                                                    <script>
                                                        function showSpinner() {
                                                            var spinner = document.querySelector('.spinner-border');
                                                            if (spinner.style.display === 'none' || spinner.style.display === '') {
                                                                spinner.style.display = 'inline-block';
                                                            }
                                                        }
                                                    </script>

                                                    <div class="row m-2">
                                                        
                                                        <button type="submit" onclick=submitFormWithAction('save') class="btn btn-soft-success rounded-pill">Speichern</button>

                                                    </div>
                                                    <div class="d-flex align-items-center">
                                                            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true" style="display: none;"></span>
                                                            </div>
                                                        <button hidden type="submit" onclick=submitFormWithAction('save') id="save-all-forms" class="btn btn-soft-success rounded-pill" >Speichern</button>

                                                
                                                    <div class="row m-2">
                                                        <button type="button" id="pdf_erstellen" data-bs-toggle="modal" data-bs-target="#info-alert-modal" class="btn btn-outline-info rounded-pill">Angebot PDF erstellen</button>
                                                        
                                                    </div>
                                                    <div id="info-alert-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
                                                        <div class="modal-dialog modal-dialog-centered">
                                                            <div class="modal-content">
                                                                <div class="modal-body p-4">
                                                                    <div class="text-center">
                                                                        <i class="ri-information-line h1 text-info"></i>
                                                                        <h4 class="mt-2">Achtung!</h4>
                                                                        <p class="mt-3">Diese Aktion setzt den Status des Angebots automatisch auf "bekommen" und leitet Sie zur PDF-Seite des Angebots weiter. Wollen Sie das fortsetzen?"</p>
                                                                        
                                                                            {% comment %} <script>
                                                                                function getCookie(name) {
                                                                                    let cookieValue = null;
                                                                                    if (document.cookie && document.cookie !== '') {
                                                                                        const cookies = document.cookie.split(';');
                                                                                        for (let i = 0; i < cookies.length; i++) {
                                                                                            const cookie = cookies[i].trim();
                                                                                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                                                                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                                                                                break;
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                    return cookieValue;
                                                                                }
                                                                                const csrftoken = getCookie('csrftoken');
                                                                                $.ajaxSetup({
                                                                                    headers: { "X-CSRFToken": csrftoken }
                                                                                });
                                                                                    function setAction(action) {
                                                                                        document.getElementById('form-action').value = action;
                                                                                    }
                                                                                function saveFormAndGeneratePDF() {
                                                                                    // Set the status value to "bekommen" before the form submission
                                                                                    // $('#id_status').val('bekommen');
                                                                                    $('#is_locked').val('True');
                                                                                    
                                                                                    // Continue with the AJAX POST request to save the form
                                                                                    $.ajax({
                                                                                        type: "POST",
                                                                                        url: $("#main-form").attr('action'),
                                                                                        data: $("#main-form").serialize(),
                                                                                        // success: function(data){
                                                                                            // Once the form is successfully saved, redirect to generate the PDF
                                                                                        //    window.location.href = "{% url 'vertrieb_interface:create_angebot_pdf_user' vertrieb_angebot.angebot_id %}";
                                                                                        //},
                                                                                        error: function(err){
                                                                                            // Handle any errors accordingly
                                                                                            console.error("Error saving form:", err);
                                                                                        }
                                                                                    });
                                                                                }
                                                                            </script>  {% endcomment %}
                                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                                                                            
                                                                            <button type="submit" onclick=submitFormWithAction('switch_to_bekommen') id="continueButtonn" class="btn btn-info my-2" data-bs-dismiss="modal">Weiter...</button>

                                                                    </div>
                                                                </div>
                                                            </div><!-- /.modal-content -->
                                                        </div><!-- /.modal-dialog -->
                                                    </div>

                                                    <div class="row m-2">
                                                        <button type="button" id="pdf_and_calc_erstellen" data-bs-toggle="modal" data-bs-target="#info-alert-modal2" class="btn btn-outline-info rounded-pill">Angebot PDF mit Kalkulation erstellen</button>

                                                    </div>
                                                    <div id="info-alert-modal2" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
                                                        <div class="modal-dialog modal-dialog-centered">
                                                            <div class="modal-content">
                                                                <div class="modal-body p-4">
                                                                    <div class="text-center">
                                                                        <i class="ri-information-line h1 text-info"></i>
                                                                        <h4 class="mt-2">Achtung!</h4>
                                                                        <p class="mt-3">Diese Aktion setzt den Status des Angebots automatisch auf "bekommen" und leitet Sie zur PDF-Seite des Angebots weiter. Wollen Sie das fortsetzen?"</p>
                                                                        
                                                                            
                                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                                                                            <button type="submit" onclick=submitFormWithAction('switch_to_bekommen_pdf_plus_kalk') id="continueButtonnn" class="btn btn-info my-2" data-bs-dismiss="modal">Weiter...</button>
                                                                    </div>
                                                                </div>
                                                            </div><!-- /.modal-content -->
                                                        </div><!-- /.modal-dialog -->


                                                                                                                <script>
                                                            document.addEventListener('DOMContentLoaded', function () {
                                                                var pdfButton = document.getElementById('pdf_erstellen');
                                                                var pdfButton2 = document.getElementById('pdf_and_calc_erstellen');
                                                                var pdfButton3 = document.getElementById('continueButtonn');
                                                                var pdfButton4 = document.getElementById('continueButtonnn');

                                                                pdfButton4.addEventListener('click', function() {
                                                                    this.disabled = true; // Disable the button
                                                                    this.classList.add('disabled'); // Optional: Add a class to change the appearance
                                                                    pdfButton2.disabled = true; // Disable the second button
                                                                    pdfButton2.classList.add('disabled'); // Optional: Add a class for the second button
                                                                });

                                                                // If you want similar functionality for pdfButton2, add an event listener here
                                                                pdfButton3.addEventListener('click', function() {
                                                                    this.disabled = true;
                                                                    this.classList.add('disabled');
                                                                    pdfButton.disabled = true; // Disable the second button
                                                                    pdfButton.classList.add('disabled'); // Optional: Add a class for the second button
                                                                    // Add any other functionality you need for pdfButton2
                                                                });
                                                            });

                                                        </script>
                                                    </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>    
                        <div class="col-xxl-8">
                            <div class="card border-info border">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h4 class="header-title">Visualisierung der voraussichtlichen Amortisationszeit</h4>
                                    <div class="dropdown">
                                        <a href="#" class="dropdown-toggle arrow-none card-drop" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="mdi mdi-dots-vertical"></i>
                                        </a>
                                    </div>
                                </div>
                                <div class="card-body pt-0">
                                    <div dir="ltr">
                                        <div id="revenue-statistics-chart" class="apex-charts" data-colors="#727cf5,#0acf97"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div> 
        </form>

        
        {% comment %} <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> {% endcomment %}
        <script>
$(document).ready(function() {
    toggleAnzWandhalterung($('#hersteller').val());
    calculateGesamtkapazitat();
    $('#anz_speicher').change(calculateGesamtkapazitat);

    $("#hersteller").change(function() {
        toggleAnzWandhalterung($(this).val());
        calculateGesamtkapazitat(); // Recalculate when manufacturer changes
        
        var hersteller = $(this).val();
        var wechselrichterOptions, speicherOptions, wallboxtypOptions;
        
        if(hersteller == "Viessmann") {
            limitModulanzahl(28);
            wechselrichterOptions = '<option value="Vitocharge VX3">Vitocharge VX3</option>';
            speicherOptions = '<option value="Vitocharge VX3 PV-Stromspeicher">Vitocharge VX3 PV-Stromspeicher</option>';
            wallboxtypOptions = '<option value="Viessmann Charging Station">Viessmann Charging Station</option>';
        } else if(hersteller == "Huawei") {
            wechselrichterOptions = '<option value="SUN 2000">SUN 2000</option>';
            speicherOptions = '<option value="LUNA 2000">LUNA 2000</option>';
            wallboxtypOptions = '<option value="Huawei FusionCharge AC">Huawei FusionCharge AC</option>';
        } else {
            wechselrichterOptions = speicherOptions = wallboxtypOptions = '<option value="">-----</option>';
        }

        $("#wechselrichter_model").html(wechselrichterOptions);
        $("#speicher_model").html(speicherOptions);
        $("#wallboxtyp").html(wallboxtypOptions);
    });
});

function toggleAnzWandhalterung(value) {
    if (value === 'Viessmann') {
        $('#anz_wandhalterung_row').hide();
    } else {
        $('#anz_wandhalterung_row').show();
    }
}

function calculateGesamtkapazitat() {
    var anz_speicher = parseInt($('#anz_speicher').val()) || 0;
    var hersteller = $('#hersteller').val(); // Correctly get the value as a string
    var gesamtkapazitat = 0; // Initialize to ensure it has a value even if conditions fail

    if (hersteller === 'Huawei') {
        gesamtkapazitat = anz_speicher * 5;
    } else if (hersteller === 'Viessmann') { // Corrected syntax for the if statement
        gesamtkapazitat = anz_speicher * 5; // Adjusted calculation for Viessmann
    }

    $('#gesamtkapazitat').val(gesamtkapazitat);
}

function limitModulanzahl(maxValue) {
    $('#modulanzahl').change(function() {
        var value = parseInt($(this).val());
        if (value > maxValue) {
            alert('Modulanzahl cannot be more than ' + maxValue + ' when Hersteller is Viessmann.');
            $(this).val(maxValue);
        }
    });
}

function submitFormWithAction(actionType) {
    document.getElementById('actionType').value = actionType;
    document.getElementById('main-form').submit();
}
</script>



        {% comment %} <script>
        $(document).ready(function() {
            toggleAnzWandhalterung($('#hersteller').val());
            calculateGesamtkapazitat();
            $('#anz_speicher').change(calculateGesamtkapazitat);

            $("#hersteller").change(function() {
                toggleAnzWandhalterung($(this).val());
                
                var hersteller = $(this).val();
                var wechselrichterOptions, speicherOptions, wallboxtypOptions;
                
                if(hersteller == "Viessmann") {
                    limitModulanzahl(28);
                    wechselrichterOptions = '<option value="Vitocharge VX3">Vitocharge VX3</option>';
                    speicherOptions = '<option value="Vitocharge VX3 PV-Stromspeicher">Vitocharge VX3 PV-Stromspeicher</option>';
                    wallboxtypOptions = '<option value="Viessmann Charging Station">Viessmann Charging Station</option>';
                } else if(hersteller == "Huawei") {
                    wechselrichterOptions = '<option value="SUN 2000">SUN 2000</option>';
                    speicherOptions = '<option value="LUNA 2000">LUNA 2000</option>';
                    wallboxtypOptions = '<option value="Huawei FusionCharge AC">Huawei FusionCharge AC</option>';
                } else {
                    wechselrichterOptions = speicherOptions = wallboxtypOptions = '<option value="">-----</option>';
                }

                $("#wechselrichter_model").html(wechselrichterOptions);
                $("#speicher_model").html(speicherOptions);
                $("#wallboxtyp").html(wallboxtypOptions);
            });
        });

        function toggleAnzWandhalterung(value) {
            if (value === 'Viessmann') {
                $('#anz_wandhalterung_row').hide();
            } else {
                $('#anz_wandhalterung_row').show();
            }
        }

        function calculateGesamtkapazitat() {
            var anz_speicher = parseInt($('#anz_speicher').val()) || 0;
            $('#gesamtkapazitat').val(anz_speicher * 5);
        }

        function limitModulanzahl(maxValue) {
                $('#modulanzahl').change(function() {
                    var value = parseInt($(this).val());
                    if (value > maxValue) {
                        alert('Modulanzahl cannot be more than ' + maxValue + ' when Hersteller is Viessmann.');
                        $(this).val(maxValue);
                    }
                });
            }
            function submitFormWithAction(actionType) {
        document.getElementById('actionType').value = actionType;
        document.getElementById('main-form').submit();
    }
        </script> {% endcomment %}


    <!--- #############################################################################################-->


    {% else %}
        <form id="main-form" method="POST" onsubmit="updateDisplay();" action="{% url 'vertrieb_interface:edit_angebot' angebot_id=vertrieb_angebot.angebot_id %}">
            {% csrf_token %}
            <div class="container-fluid">     
                {% if form.errors %}
                <div class="alert alert-danger">Please correct the following errors:
                    <ul>
                        {% for field in form %}
                            {% if field.errors %}
                                <li>{{ field.label }} - {{ field.errors.0 }}</li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </div>
                    {% endif %}
                <div class="row">
                    <div class="col-7">
                        <div class="page-title-box">
                            {% if user.role.name == "admin" %}
                                <h4 class="page-title">Juno Solar Vertriebsportal : {{ user.role.name }}</h4>
                            {% else %}
                                <h4 class="page-title">Juno Solar Vertriebsportal</h4>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="row">
                        <div class="col-xl-12">
                            <div class="card">
                                <div class="card-body">
                                        <ul class="nav nav-tabs nav-justified nav-bordered mb-4" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <a href="#info" data-bs-toggle="tab" aria-expanded="true" class="nav-link active" aria-selected="fakse" role="tab">
                                                    <i class="mdi mdi-home-variant d-md-none d-block"></i>
                                                    <span class="d-none d-md-block h4">Info</span>
                                                </a>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <a href="#module" onclick=toggleActiveTabFeature() data-bs-toggle="tab" aria-expanded="true" class="nav-link" aria-selected="true" tabindex="-1" role="tab">
                                                    <i class="mdi mdi-panorama-sphere-outline d-md-none d-block"></i>
                                                    <span class="d-none d-md-block h4">Module & Zubehör</span>
                                                </a>
                                            </li>
                                            {% if vertrieb_angebot.status == "angenommen" %}
                                            <li hidden class="nav-item" role="presentation">
                                                <a href="#ticket" data-bs-toggle="tab" aria-expanded="true" class="nav-link" aria-selected="false" tabindex="-1" role="tab">
                                                    <i class="mdi mdi-altimeter d-md-none d-block"></i>
                                                    <span class="d-none d-md-block h4">Ticket</span>
                                                </a>
                                            </li>
                                            {% endif %}
                                            <li class="nav-item" role="presentation">
                                                <a href="#kalkulationen" data-bs-toggle="tab" aria-expanded="true" class="nav-link " aria-selected="false" tabindex="-1" role="tab">
                                                    <i class="mdi mdi-application-brackets-outline d-md-none d-block"></i>
                                                    <span class="d-none d-md-block h4">Kalkulationen</span>
                                                </a>
                                            </li>
                                        </ul>
                                    <div class="tab-content">
                                        <div class="tab-pane show active" id="info" role="presentation">
                                            <div class="card-body">
                                                <div class="row">
                                                    <!-- Column 1 -->
                                                    <div class="col-lg-5">
                                                        <div class="card mb-3">
                                                        <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Interessenteninfo</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tbody>
                                                                        <tr hidden>
                                                                            <th></th>
                                                                            <td hidden>
                                                                                <div class="custom-control custom-switch">
                                                                                    <input type="checkbox" class="custom-control-input" id="switch10" {% if form.is_locked.value %}checked{% endif %} data-switch="success" name="{{ form.is_locked.html_name }}"/>
                                                                                    <label class="custom-control-label" for="switch10" data-on-label="Yes" data-off-label="No"></label>
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                        <tr hidden>
                                                                            <th>{{ form.zoho_id.label_tag }}</th>
                                                                            <td>{{ form.zoho_id }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.name.label_tag }}</th>
                                                                            <td><input type="text" class="form-control" name="{{ form.name.name }}" value="{{ form.name.value }}" readonly></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.anrede.label_tag }}</th>
                                                                            <td><input type="text" class="form-control" name="{{ form.anrede.name }}" value="{{ form.anrede.value }}" readonly></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.vorname_nachname.label_tag }}</th>
                                                                            <td><input type="text" class="form-control" name="{{ form.vorname_nachname.name }}" value="{{ form.vorname_nachname.value }}" readonly></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.telefon_mobil.label_tag }}</th>
                                                                            <td><input type="text" class="form-control" name="{{ form.telefon_mobil.name }}" value="{{ form.telefon_mobil.value }}" readonly></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.telefon_festnetz.label_tag }}</th>
                                                                            <td><input type="text" class="form-control" name="{{ form.telefon_festnetz.name }}" value="{{ form.telefon_festnetz.value }}" readonly></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.email.label_tag }}</th>
                                                                            <td><input type="text" class="form-control" name="{{ form.email.name }}" value="{{ form.email.value }}" readonly></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.firma.label_tag }}</th>
                                                                            <td><input type="text" class="form-control" name="{{ form.firma.name }}" value="{{ form.firma.value }}" readonly></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.strasse.label_tag }}</th>
                                                                            <td><input type="text" class="form-control" name="{{ form.strasse.name }}" value="{{ form.strasse.value }}" readonly></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.ort.label_tag }}</th>
                                                                            <td><input type="text" class="form-control" name="{{ form.ort.name }}" value="{{ form.ort.value }}" readonly></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.anlagenstandort.label_tag }}</th>
                                                                            <td><input type="text" class="form-control" name="{{ form.anlagenstandort.name }}" value="{{ form.anlagenstandort.value }}" readonly></td>
                                                                            <td hidden>{{ form.postanschrift_latitude }}</td>
                                                                            <td hidden>{{ form.postanschrift_longitude }}</td>
                                                                        </tr>
                                                                        
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                        <!-- Column 2 -->
                                                            {% if user.map_notizen_container_view == "Map" %}
                                                                {% include 'vertrieb/extra/map.html' %}
                                                            {% elif user.map_notizen_container_view == "Notizen" %}
                                                                {% include 'vertrieb/extra/notizen.html' %}
                                                           {% endif %}
                                                </div><!-- End of row -->
                                            </div>
                                        </div>
                                        <div class="tab-pane" id="module" role="presentation">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-lg-3">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Wechselrichter & Speicher</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tr>
                                                                        <th>{{ form.hersteller.label_tag }}</th>
                                                                        <td><input type="text" class="form-control" name="{{ form.hersteller.name }}" value="{{ form.hersteller.value }}" readonly></td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.wechselrichter_model.label_tag }}</th>
                                                                        <td><input type="text" class="form-control" name="{{ form.wechselrichter_model.name }}" value="{{ form.wechselrichter_model.value }}" readonly></td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.speicher_model.label_tag }}</th>
                                                                        <td><input type="text" class="form-control" name="{{ form.speicher_model.name }}" value="{{ form.speicher_model.value }}" readonly></td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.anz_speicher.label_tag }}</th>
                                                                        <td><input type="text" class="form-control" name="{{ form.anz_speicher.name }}" value="{{ form.anz_speicher.value }}" readonly></td>
                                                                    </tr>

                                                                    <tr>
                                                                        <th>{{ form.gesamtkapazitat.label_tag }}kWh</th>
                                                                        <td><input type="text" readonly class="form-control-plaintext" id="gesamtkapazitat" value="{{ form.gesamtkapazitat.value }}"></td>
                                                                        
                                                                        
                                                                    </tr>
                                                                </table>
                                                            </div>
                                                        </div>

                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Gesamtpreis PV-Anlage (inkl. Monatge)</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tr>
                                                                        <th>Preis Netto</th>
                                                                        <td>{{ vertrieb_angebot.angebotsumme|format_price }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Preis Brutto</th>
                                                                        <td>{{ vertrieb_angebot.angebotsumme|format_price }}</td>
                                                                    </tr>
                                                                </table>
                                                                {% if vertrieb_angebot.angebot_id_assigned == False %}
                                                                <button type="submit" name="angebotsumme_rechnen" form="main-form" class="btn btn-soft-info rounded-pill">Angebot Summe rechnen</button>
                                                                {% else %}
                                                                <button type="submit" form="main-form" disabled id="save-all-forms" class="btn btn-outline-info rounded-pill">Angebot Summe rechnen</button>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div> 
                                                    <div class="col-lg-3">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Module</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tr>
                                                                        <th>{{ form.solar_module.label_tag }}</th>
                                                                        <td><input type="text" class="form-control" name="{{ form.solar_module.name }}" value="{{ form.solar_module.value }}" readonly></td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.modulanzahl.label_tag }}</th>
                                                                        <td id="modulanzahl" name="modulanzahl" data-bs-toggle="tooltip">
                                                                            <input type="text" class="form-control" name="{{ form.modulanzahl.name }}" value="{{ form.modulanzahl.value }}" readonly>
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.garantieWR.label_tag }}</th>
                                                                        <td><input type="text" class="form-control" name="{{ form.garantieWR.name }}" value="{{ form.garantieWR.value }}" readonly></td>
                                                                    </tr>

                                                                    <tr hidden>
                                                                        <th>{{ form.eddi.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="switch03" {% if form.eddi.value %}checked{% endif %} data-switch="success" name="{{ form.eddi.html_name }}" />
                                                                                <label class="custom-control-label" for="switch03" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    
                                                                    <tr>
                                                                        <th>{{ form.notstrom.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" disabled id="switch04" {% if form.notstrom.value %}checked{% endif %} data-switch="success" name="{{ form.notstrom.html_name }}" readonly/>
                                                                                <label class="custom-control-label" for="switch04" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.anzOptimizer.label_tag }}</th>
                                                                        <td id="anzOptimizer" name="anzOptimizer" data-bs-toggle="tooltip">
                                                                            <input type="text" class="form-control" name="{{ form.anzOptimizer.name }}" value="{{ form.anzOptimizer.value }}" readonly>
                                                                        </td>
                                                                    </tr>

                                                                    <tr>
                                                                        <th>Modulleistung [Wp]</th>
                                                                        <td id="modulleistungWp" name="modulleistungWp">{{ vertrieb_angebot.modulleistungWp }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Modullsumme [kWp]</th>
                                                                        <td id="modulsumme_kWp" name="modulsumme_kWp">{{ vertrieb_angebot.modulsumme_kWp }}</td>
                                                                    </tr>
                                                                </table>
                                                                <table class="table table-sm table-hover">
                                                                    <tr>
                                                                        <th>Zahlungsmodalitäten</th>
                                                                        <td>{{ form.zahlungsbedingungen }}</td>
                                                                    </tr>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Zubehör</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tbody>
                                                                        {% include 'vertrieb/extra/wand_content_readonly.html' %}
                                                                        {% include 'vertrieb/extra/elwa_2_content_readonly.html' %}
                                                                        {% include 'vertrieb/extra/thor_2_content_readonly.html' %}
                                                                        {% include 'vertrieb/extra/wallbox_content_readonly.html' %}
                                                                        {% include 'vertrieb/extra/komplex_content_readonly.html' %}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Energie Details</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tr>
                                                                        <th>Erzeugte Energie pro Jahr [kWh]</th>
                                                                        <td>{{ vertrieb_angebot.erzeugte_energie_pro_jahr|format_number }} </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Nutzbare PV-Energie [kWh]</th>
                                                                        <td>{{ vertrieb_angebot.nutzbare_nutzenergie|format_number }} </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Benögte Restenegie [kWh]</th>
                                                                        <td>{{ vertrieb_angebot.benotigte_restenergie|format_number }} </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>kosten für Restenegie [€]</th>
                                                                        <td>{{ vertrieb_angebot.kosten_fur_restenergie|format_price }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Einspreisevergütung gesamt [€]</th>
                                                                        <td>{{ vertrieb_angebot.einspreisevergütung_gesamt|format_price }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Stromkosten ohne PV-Anlage [€]</th>
                                                                        <td>{{ vertrieb_angebot.strom_ohne|format_price }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Preis abzgl Vergütung und inkl. Restrom [€]</th>
                                                                        <td>{{ vertrieb_angebot.abzug_vergutung|format_price }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Ersparnis [€]</th>
                                                                        <td>{{ vertrieb_angebot.Ersparnis|format_price }}</td>
                                                                    </tr>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row"> 
                                                    {% if user.role.name == "admin" %}
                                                    <div class="col-lg-3">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Individual Preis</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tr>
                                                                        <th>{{ form.indiv_price_included.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="switch_indiv_price_included" {% if form.indiv_price_included.value %}checked{% endif %} data-switch="success" name="{{ form.indiv_price_included.html_name }}" />
                                                                                <label class="custom-control-label" for="switch_indiv_price_included" data-on-label="Yes" data-off-label="No"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr id="indiv_price_row">
                                                                        <th>{{form.indiv_price.label_tag }}</th>
                                                                        <td>{{ form.indiv_price }}</td>
                                                                    </tr>
                                                                </table>
                                                                <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
                                                                <script type="text/javascript">
                                                                    $(document).ready(function() {
                                                                        // Initial state of 'Inddiv Preis' row
                                                                        updateIndivPreisRow();
                                                                
                                                                        // On 'Indiv Preis inkl.' checkbox state change
                                                                        $('#switch_indiv_price_included').change(function() {
                                                                            updateIndivPreisRow();
                                                                        });
                                                                
                                                                        function updateIndivPreisRow() {
                                                                            if ($('#switch_indiv_price_included').is(':checked')) {
                                                                                // If checkbox is checked, show 'Inddiv Preis' row
                                                                                $('#indiv_price_row').show();
                                                                            } else {
                                                                                // If checkbox is not checked, hide 'Inddiv Preis' row
                                                                                $('#indiv_price_row').hide();
                                                                            }
                                                                        }
                                                                    });
                                                                </script>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div> 
                                            </div>
                                        </div>
                                        {% if vertrieb_angebot.status == "angenommen" %}
                                        <div hidden class="tab-pane" id="ticket" role="presentation">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-lg-5">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 bg-opacity-75 bg-gradient text-white">Solar Module & Anzahl </div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tbody>
                                                                        <tr>
                                                                            <th>{{ form.solar_module.label_tag }}</th>
                                                                            <td>{{ form.module_ticket }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.modul_anzahl_ticket.label_tag }}</th>
                                                                            <td>{{ form.modul_anzahl_ticket }}</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-4">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 bg-opacity-75 bg-gradient text-white">Zusätzlich & Abzüge:</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tbody>
                                                                        <tr>
                                                                            <th>{{ form.optimizer_ticket.label_tag }}</th>
                                                                            <td>{{ form.optimizer_ticket }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.batteriemodule_ticket.label_tag }}</th>
                                                                            <td>{{ form.batteriemodule_ticket }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.notstrom_ticket.label_tag }}</th>
                                                                            <td>{{ form.notstrom_ticket }}</td>
                                                                        </tr>
                                                                        <tr hidden>
                                                                            <th>{{ form.eddi_ticket.label_tag }}</th>
                                                                            <td>{{ form.eddi_ticket }}</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                
                                                    <div class="col-lg-3">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 bg-opacity-75 bg-gradient text-white">Ticket Preis</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tbody>
                                                                        <tr>
                                                                            <th>Gesamtticketpreis Netto</th>
                                                                            <td>{{ vertrieb_angebot.Full_ticket_preis }} €</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>Gesamtticketpreis Brutto</th>
                                                                            <td>{{ vertrieb_angebot.Full_ticket_preis }} €</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% if vertrieb_angebot.angebot_id_assigned %}
                                                    <div class="col-lg-3">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Pdf-Erstellung verfügbar</div>
                                                            <div class="card-body">
                                                                
                                                                <a href="{% url 'vertrieb_interface:create_ticket_pdf' vertrieb_angebot.angebot_id %}" class="btn btn-outline-info rounded-pill">PDF-Ticket Erstellen</a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}                        
                                        <div class="tab-pane" id="kalkulationen" role="presentation">                       
                                            <div class="card-body">
                                                <div class="row">

                                                    <div class="col-lg-4">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Kalkulation Info</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tbody>
                                                                        <tr>
                                                                            <th>{{ form.verbrauch.label_tag }}</th>
                                                                            <td>{{ form.verbrauch }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.grundpreis.label_tag }}</th>
                                                                            <td>{{ form.grundpreis }}</td> 
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.arbeitspreis.label_tag }}</th>
                                                                            <td id="arbeitspreis" name="arbeitspreis">{{ form.arbeitspreis }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.prognose.label_tag }}</th>
                                                                            <td>{{ form.prognose }}</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Pdf-Erstellung verfügbar</div>
                                                            <div class="card-body">
                                                                <button type="button" action="{% url 'vertrieb_interface:create_calc_pdf' angebot_id=vertrieb_angebot.angebot_id %}" class="btn btn-outline-info rounded-pill">PDF-Kalkulation erstellen</button>
                                                                {% if vertrieb_angebot.angebot_id_assigned == False %}
                                                                <button type="submit" name="angebotsumme_rechnen" form="main-form" class="btn btn-outline-info rounded-pill">Kalkulation rechnen</button>
                                                                {% else %}
                                                                <button type="submit" form="main-form" disabled id="save-all-forms" class="btn btn-outline-info rounded-pill">Kalkulation rechnen</button>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="col-lg-4">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Kalkulation Info</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tbody>
                                                                        <tr>
                                                                            <th>{{ form.bis10kWp.label_tag }} </th>
                                                                            <td>{{ form.bis10kWp }} </td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.bis40kWp.label_tag }} </th>
                                                                            <td>{{ form.bis40kWp }} </td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.zeitraum.label_tag }}</th>
                                                                            <td>{{ form.zeitraum }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.ausrichtung.label_tag }}</th>
                                                                            <td>{{ form.ausrichtung }}</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                        
                                                    </div>
                                                    <div class="col-lg-4">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Energy Details</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tr>
                                                                        <th>Erzeugte Energie pro Jahr [kWh]</th>
                                                                        <td>{{ vertrieb_angebot.erzeugte_energie_pro_jahr|format_number }} kWh</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Nutzbare PV-Energie [kWh]</th>
                                                                        <td>{{ vertrieb_angebot.nutzbare_nutzenergie|format_number }} kWh</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Benögte Restenegie [kWh]</th>
                                                                        <td>{{ vertrieb_angebot.benotigte_restenergie|format_number }} kWh</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>kosten für Restenegie</th>
                                                                        <td>{{ vertrieb_angebot.kosten_fur_restenergie|format_price }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Einspreisevergütung gesamt [€]</th>
                                                                        <td>{{ vertrieb_angebot.einspreisevergütung_gesamt|format_price }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Stromkosten ohne PV-Anlage</th>
                                                                        <td>{{ vertrieb_angebot.strom_ohne|format_price }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Preis abzgl Vergütung und inkl. Restrom</th>
                                                                        <td>{{ vertrieb_angebot.abzug_vergutung|format_price }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Ersparnis [€]</th>
                                                                        <td>{{ vertrieb_angebot.Ersparnis|format_price }}</td>
                                                                    </tr>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                <div class="row">
                    <div class="col-xxl-6">
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="card widget-flat">
                                    <div class="card-body">
                                        <div class="float-end">
                                            <i class="mdi mdi-file-document widget-icon"></i>
                                        </div>
                                        <h5 class="text-muted fw-normal mt-0" title="Number of Customers">Angebot ID</h5>
                                        {% if vertrieb_angebot.angebot_id_assigned %}
                                            <h3 class="mt-3 mb-3">{{ vertrieb_angebot.angebot_id}}</h3>
                                        {% else %}
                                            <h3 class="mt-3 mb-3">Noch nicht zugeordnet</h3>
                                        {% endif %}
                                        {% if vertrieb_angebot.countdown and vertrieb_angebot.status == 'bekommen' %}
                                        <span class="text-nowrap h4"> läuft in  </span><span class="text-danger me-2 text-nowrap h4">{{ vertrieb_angebot.countdown }}</span><span class="text-nowrap h4"> ab.</span>
                                        <p></p>
                                        {% endif %}
                                        <p class="mb-0 text-muted">
                                            {% if not vertrieb_angebot.is_locked %}
                                                <span class="text-success me-2"></i> Verfügbar</span>
                                            {% else %}
                                                <span class="text-danger me-2"></i> Nicht verfügbar</span>
                                            {% endif %}    
                                                <span class="text-nowrap">Zugriff auf die Bearbeitung</span>  
                                        </p>
                                    </div> <!-- end card-body-->
                                </div> <!-- end card-->
                            </div> <!-- end col-->
                            <div class="col-sm-6">
                                <div class="card widget-flat">
                                    <div class="card-body">
                                        <div class="float-end">
                                            <i class="mdi mdi-account widget-icon"></i>
                                        </div>
                                        <h5 class="text-muted fw-normal mt-0" title="Number of Orders">Kundennumer</h5>
                                            <input type="text" readonly class="form-control-plaintext h2" id="zoho_kundennumer" value="{{ form.zoho_kundennumer.value }}">
                                            <p hidden>{{ form.zoho_kundennumer}}</p>
                                            <p></p>
                                        <p class="mb-0 text-muted">
                                        {% if not vertrieb_angebot.termine_text %}
                                            <span class="text-danger me-2"></i> Kein Termin</span>
                                        {% else %}
                                            <span class="text-success me-2"></i> {{ vertrieb_angebot.termine_text }}</span>
                                        {% endif %}
                                            <span class="text-nowrap">Termin</span>
                                        </p>
                                    </div> <!-- end card-body-->
                                </div> <!-- end card-->
                            </div> <!-- end col-->
                        </div> <!-- end row -->
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="card widget-flat">
                                    <div class="card-body">
                                        {% if vertrieb_angebot.status == 'bekommen' or vertrieb_angebot.status == 'abgelaufen'%} 
                                        <div class="float-end">
                                            <button hidden name="change_status_button" id="changeStatusButton" class="btn btn-soft-info rounded-pill" type="submit">finalisieren</button>
                                        </div>
                                        {% endif %}
                                        <h5 class="text-muted fw-normal mt-0" title="Number of Orders">{{ vertrieb_angebot.anfrage_vom }}</h5>
                                        <p></p>
                                        {% if not vertrieb_angebot.is_locked %}
                                            <h4 class="text-muted fw-normal mt-0" title="Number of Orders">{{ form.status.label_tag}}:</h4>
                                            <input type="text" readonly class="form-control-plaintext h2" id="id_status" value="{{ form.status.value }}">
                                            <h4 hidden>{{ form.status }}</h4>
                                        {% else %}
                                        <h4 class="text-muted fw-normal mt-0" title="Number of Orders">{{ form.status.label_tag}}:</h4>
                                        <h4 hidden>{{ form.status }}</h4>
                                           <input type="text" readonly class="form-control-plaintext h2" id="id_status" value="{{ form.status.value }}">                                                 
                                        {% endif %}
                                        {% if vertrieb_angebot.status == 'bekommen' or vertrieb_angebot.status == 'abgelaufen'%} 
                                            <p class="mb-0 text-muted">                                         
                                                <span class="text-success me-2"></i> {{ vertrieb_angebot.status_change_field }}</span>
                                                <span class="text-nowrap">Änderungsdatum</span>
                                            </p>
                                        {% endif %}
                                        
                                    </div> <!-- end card-body-->
                                </div> <!-- end card-->
                            </div> <!-- end col-->
                            <div class="col-sm-6">
                                <div class="card widget-flat">
                                    <div class="card-body">
                                        <h5 class="text-muted fw-normal mt-0" title="Number of Orders">verfügbare Aktionen:</h5>

                                                    <script>
                                                        function showSpinner() {
                                                            var spinner = document.querySelector('.spinner-border');
                                                            if (spinner.style.display === 'none' || spinner.style.display === '') {
                                                                spinner.style.display = 'inline-block';
                                                            }
                                                        }
                                                    </script>

                                                    <div class="row m-2">
                                                        
                                                        <button type="submit" form="main-form" id="save-all-forms" class="btn btn-outline-success rounded-pill" onclick="setAction('save')" disabled>
                                                            Speichern
                                                        </button>

                                                    </div>
                                                    <div class="d-flex align-items-center">
                                                            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true" style="display: none;"></span>
                                                            </div>
                                                        <button hidden type="submit" form="main-form" id="save-all-forms" class="btn btn-success rounded-pill" >Speichern</button>

                                                
                                                    <div class="row m-2">
                                                        <button type="button" data-bs-toggle="modal" data-bs-target="#info-alert-modal" class="btn btn-outline-info rounded-pill">Angebot PDF erstellen</button>
                                                        
                                                    </div>
                                                    <div id="info-alert-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
                                                        <div class="modal-dialog modal-dialog-centered">
                                                            <div class="modal-content">
                                                                <div class="modal-body p-4">
                                                                    <div class="text-center">
                                                                        <i class="ri-information-line h1 text-info"></i>
                                                                        <h4 class="mt-2">Achtung!</h4>
                                                                        <p class="mt-3">Diese Aktion setzt den Status des Angebots automatisch auf "bekommen" und leitet Sie zur PDF-Seite des Angebots weiter. Wollen Sie das fortsetzen?"</p>
                                                                        <script>
                                                                            function redirectToPdfCreation() {
                                                                                // Replace 'yourUrl' with the Django URL generated by the template tag
                                                                                var yourUrl = "{% url 'vertrieb_interface:create_angebot_pdf_user' vertrieb_angebot.angebot_id %}";
                                                                                window.location.href = yourUrl;
                                                                            }
                                                                        </script>

                                                                            
                                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                                                                            <button type="button" id="pdf_erstellen" onclick="redirectToPdfCreation();" class="btn btn-info my-2" data-bs-dismiss="modal">Weiter...</button>

                                                                    </div>
                                                                </div>
                                                            </div><!-- /.modal-content -->
                                                        </div><!-- /.modal-dialog -->
                                                    </div>

                                                    <div class="row m-2">
                                                        <button type="button" data-bs-toggle="modal" data-bs-target="#info-alert-modal2" class="btn btn-outline-info rounded-pill">Angebot PDF mit Kalkulation erstellen</button>
                                                        <script>
                                                            document.addEventListener('DOMContentLoaded', function () {
                                                                var pdfButton = document.getElementById('pdf_erstellen');
                                                                var pdfButton2 = document.getElementById('pdf_and_calc_erstellen');

                                                                pdfButton.addEventListener('click', function() {
                                                                    this.disabled = true; // Disable the button
                                                                    this.classList.add('disabled'); // Optional: Add a class to change the appearance
                                                                    pdfButton2.disabled = true; // Disable the second button
                                                                    pdfButton2.classList.add('disabled'); // Optional: Add a class for the second button
                                                                });

                                                                // If you want similar functionality for pdfButton2, add an event listener here
                                                                pdfButton2.addEventListener('click', function() {
                                                                    this.disabled = true;
                                                                    this.classList.add('disabled');
                                                                    pdfButton.disabled = true; // Disable the second button
                                                                    pdfButton.classList.add('disabled'); // Optional: Add a class for the second button
                                                                    // Add any other functionality you need for pdfButton2
                                                                });
                                                            });

                                                        </script>
                                                    </div>
                                                    <div id="info-alert-modal2" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
                                                        <div class="modal-dialog modal-dialog-centered">
                                                            <div class="modal-content">
                                                                <div class="modal-body p-4">
                                                                    <div class="text-center">
                                                                        <i class="ri-information-line h1 text-info"></i>
                                                                        <h4 class="mt-2">Achtung!</h4>
                                                                        <p class="mt-3">Diese Aktion setzt den Status des Angebots automatisch auf "bekommen" und leitet Sie zur PDF-Seite des Angebots weiter. Wollen Sie das fortsetzen?"</p>
                                                                        <script>
                                                                            function redirectToPdfCalcCreation() {
                                                                                // Replace 'yourUrl' with the Django URL generated by the template tag
                                                                                var yourUrl = "{% url 'vertrieb_interface:create_angebot_and_calc_pdf' vertrieb_angebot.angebot_id %}";
                                                                                window.location.href = yourUrl;
                                                                            }
                                                                        </script>
                                                                        
                                                                            
                                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                                                                            
                                                                            <button type="button" id="pdf_and_calc_erstellen" onclick="redirectToPdfCalcCreation();" class="btn btn-info my-2" data-bs-dismiss="modal">Weiter...</button>
                                                                    </div>
                                                                </div>
                                                            </div><!-- /.modal-content -->
                                                        </div><!-- /.modal-dialog -->
                                                    </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                        
                    <div class="col-xxl-8">
                        <div class="card border-info border">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h4 class="header-title">Visualisierung der voraussichtlichen Amortisationszeit</h4>
                                <div class="dropdown">
                                    <a href="#" class="dropdown-toggle arrow-none card-drop" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="mdi mdi-dots-vertical"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="card-body pt-0">
                                <div dir="ltr">
                                    <div id="revenue-statistics-chart" class="apex-charts" data-colors="#727cf5,#0acf97"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div><!-- End ROW -->
            </div> 
        </form>
       
{% endif %}

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
       <script>
$(document).ready(function() {
    toggleAnzWandhalterung($('#hersteller').val());
    calculateGesamtkapazitat();
    $('#anz_speicher').change(calculateGesamtkapazitat);

    $("#hersteller").change(function() {
        toggleAnzWandhalterung($(this).val());
        calculateGesamtkapazitat(); // Recalculate when manufacturer changes
        
        var hersteller = $(this).val();
        var wechselrichterOptions, speicherOptions, wallboxtypOptions;
        
        if(hersteller == "Viessmann") {
            limitModulanzahl(28);
            wechselrichterOptions = '<option value="Vitocharge VX3">Vitocharge VX3</option>';
            speicherOptions = '<option value="Vitocharge VX3 PV-Stromspeicher">Vitocharge VX3 PV-Stromspeicher</option>';
            wallboxtypOptions = '<option value="Viessmann Charging Station">Viessmann Charging Station</option>';
        } else if(hersteller == "Huawei") {
            wechselrichterOptions = '<option value="SUN 2000">SUN 2000</option>';
            speicherOptions = '<option value="LUNA 2000">LUNA 2000</option>';
            wallboxtypOptions = '<option value="Huawei FusionCharge AC">Huawei FusionCharge AC</option>';
        } else {
            wechselrichterOptions = speicherOptions = wallboxtypOptions = '<option value="">-----</option>';
        }

        $("#wechselrichter_model").html(wechselrichterOptions);
        $("#speicher_model").html(speicherOptions);
        $("#wallboxtyp").html(wallboxtypOptions);
    });
});

function toggleAnzWandhalterung(value) {
    if (value === 'Viessmann') {
        $('#anz_wandhalterung_row').hide();
    } else {
        $('#anz_wandhalterung_row').show();
    }
}

function calculateGesamtkapazitat() {
    var anz_speicher = parseInt($('#anz_speicher').val()) || 0;
    var hersteller = $('#hersteller').val(); // Correctly get the value as a string
    var gesamtkapazitat = 0; // Initialize to ensure it has a value even if conditions fail

    if (hersteller === 'Huawei') {
        gesamtkapazitat = anz_speicher * 5;
    } else if (hersteller === 'Viessmann') { // Corrected syntax for the if statement
        gesamtkapazitat = anz_speicher * 5; // Adjusted calculation for Viessmann
    }

    $('#gesamtkapazitat').val(gesamtkapazitat);
}

function limitModulanzahl(maxValue) {
    $('#modulanzahl').change(function() {
        var value = parseInt($(this).val());
        if (value > maxValue) {
            alert('Modulanzahl cannot be more than ' + maxValue + ' when Hersteller is Viessmann.');
            $(this).val(maxValue);
        }
    });
}

function submitFormWithAction(actionType) {
    document.getElementById('actionType').value = actionType;
    document.getElementById('main-form').submit();
}
</script>

        {% comment %} <script>
        $(document).ready(function() {
            toggleAnzWandhalterung($('#hersteller').val());
            calculateGesamtkapazitat();
            $('#anz_speicher').change(calculateGesamtkapazitat);

            $("#hersteller").change(function() {
                toggleAnzWandhalterung($(this).val());
                
                var hersteller = $(this).val();
                var wechselrichterOptions, speicherOptions, wallboxtypOptions;
                
                if(hersteller == "Viessmann") {
                    limitModulanzahl(28);
                    wechselrichterOptions = '<option value="Vitocharge VX3">Vitocharge VX3</option>';
                    speicherOptions = '<option value="Vitocharge VX3 PV-Stromspeicher">Vitocharge VX3 PV-Stromspeicher</option>';
                    wallboxtypOptions = '<option value="Viessmann Charging Station">Viessmann Charging Station</option>';
                } else if(hersteller == "Huawei") {
                    wechselrichterOptions = '<option value="SUN 2000">SUN 2000</option>';
                    speicherOptions = '<option value="LUNA 2000">LUNA 2000</option>';
                    wallboxtypOptions = '<option value="Huawei FusionCharge AC">Huawei FusionCharge AC</option>';
                } else {
                    wechselrichterOptions = speicherOptions = wallboxtypOptions = '<option value="">-----</option>';
                }

                $("#wechselrichter_model").html(wechselrichterOptions);
                $("#speicher_model").html(speicherOptions);
                $("#wallboxtyp").html(wallboxtypOptions);
            });
        });

        function toggleAnzWandhalterung(value) {
            if (value === 'Viessmann') {
                $('#anz_wandhalterung_row').hide();
            } else {
                $('#anz_wandhalterung_row').show();
            }
        }

        function calculateGesamtkapazitat() {
            var anz_speicher = parseInt($('#anz_speicher').val()) || 0;
            $('#gesamtkapazitat').val(anz_speicher * 5);
        }

        function limitModulanzahl(maxValue) {
                $('#modulanzahl').change(function() {
                    var value = parseInt($(this).val());
                    if (value > maxValue) {
                        alert('Modulanzahl cannot be more than ' + maxValue + ' when Hersteller is Viessmann.');
                        $(this).val(maxValue);
                    }
                });
            }
        </script> {% endcomment %}
        {% endif %}
        <footer class="footer">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-6">
                            <script>
                                    document.write(new Date().getFullYear())</script> © Juno-Solar Home 
                <script>        
                function getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }

                document.getElementById('send_support_message').addEventListener('click', function() {
                    var csrfToken = getCookie('csrftoken'); 
                    fetch('{% url 'vertrieb_interface:send_support_message' %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({})
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                        if (data.status === 'success') {
                            $('#success-alert-modal').modal('show');
                        }
                    });
                });
            </script>
    </div>
</div>

{% endblock %}    
{% block javascript %}
<script src="{% static 'assets/vendor/select2/js/select2.min.js' %}"></script>
<script>
$(document).ready(function() {
    // Function to handle tab actions
    function handleTabs() {
        // Get the previously active tab from local storage
        var activeTab = localStorage.getItem('activeTab');

        // If there's an active tab stored, activate it
        if (activeTab) {
            $('[href="' + activeTab + '"]').tab('show');
        }

        // When any tab is clicked, save it to the local storage
        $('.nav-tabs a').on('click', function() {
            var tabId = $(this).attr('href');
            localStorage.setItem('activeTab', tabId);
        });
    }

    // Check if the page is visible
    function isPageVisible() {
        return document.visibilityState === 'visible';
    }

    // Handle page visibility change
    document.addEventListener('visibilitychange', function() {
        if (isPageVisible()) {
            // If page is visible, handle tabs
            handleTabs();
        } else {
            // If page is not visible, unbind click event to stop saving tab state
            $('.nav-tabs a').off('click');
        }
    });

    // Initial tab handling
    if (isPageVisible()) {
        handleTabs();
    }
});
</script> 



{% comment %} <script>
  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }
  
  const csrftoken = getCookie('csrftoken');
  
  document.getElementById('save-btn').addEventListener('click', function() {
      fetch('/update_vertrieb_angebot/{{ angebot_id }}/', {
          method: 'POST',
          body: JSON.stringify({
              
              'grundpreis': document.getElementById('grundpreis-input').value,
              'arbeitspreis': document.getElementById('arbeitspreis-input').value,
              'prognose': document.getElementById('prognose-input').value,
              'zeitraum': document.getElementById('zeitraum-input').value,
              'bis10kWp': document.getElementById('bis10kWp-input').value,
              'bis40kWp': document.getElementById('bis40kWp-input').value,
              'ausrichtung': document.getElementById('ausrichtung-input').value
          }),
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken
          }
      })
      .then(response => response.json())
      .then(data => console.log(data));
  });
</script> {% endcomment %}
  
<script>
$(document).ready(function() {
    var anredeField = $("#id_anrede");
    var firstNameField = $("#tr_first_name"); // Ensure this matches your field
    var lastNameLabel = $('label[for="id_nachname"]'); // Adjust the selector as necessary

    function updateFormFields() {
        if (anredeField.val() === 'Firma') {
            firstNameField.prop('hidden', true);
            lastNameLabel.text('Firma');
        } else {
            firstNameField.prop('hidden', false);
            lastNameLabel.text('Nachname');
        }
    }

    // Listen for changes on the name field to perform AJAX
    $("#id_name").change(function() {
        var url = "{% url 'vertrieb_interface:vertrieb_autofield' %}"; // Make sure this URL is correct
        var name = $(this).val();

        $.ajax({
            url: url,
            data: {
                'name': name
            },
            success: function(data) {
                // Fill the form fields with data
                $("#id_vorname_nachname").val(data.name);
                $("#id_vorname").val(data.zoho_first_name);
                $("#id_nachname").val(data.zoho_last_name);
                $("#id_zoho_id").val(data.zoho_id);
                anredeField.val(data.anrede);
                $("#zoho_kundennumer").val(data.zoho_kundennumer);
                $("#id_strasse").val(data.strasse);
                $("#id_email").val(data.email);
                $("#id_telefon_mobil").val(data.telefon_mobil);
                $("#id_telefon_festnetz").val(data.telefon_festnetz);
                $("#id_ort").val(data.ort);
                $("#id_notizen").val(data.notizen);
                $("#id_angebot_bekommen_am").val(data.angebot_bekommen_am);
                $("#longitude").val(data.postanschrift_longitude);
                $("#latitude").val(data.postanschrift_latitude);

                // Call updateFormFields to reflect any changes from AJAX response
                updateFormFields();
            }
        });
    });

    // Call updateFormFields on page load and on anrede change
    updateFormFields();
    anredeField.change(updateFormFields);
});
</script>


<script>
    let arbeitsListe = JSON.parse('{{ vertrieb_angebot.Arbeits_liste|escapejs }}');
    let restListe = JSON.parse('{{ vertrieb_angebot.Rest_liste|escapejs }}');
    let zeitraum = {{ vertrieb_angebot.zeitraum }}
    ! function(n) {
        "use strict";
    
        function t() {
            this.charts = []
        }
        t.prototype.init = function() {
            this.initCharts()
        }, t.prototype.initCharts = function() {
            var t = ["#727cf5", "#0acf97"],
                e = n("#revenue-statistics-chart").data("colors"),
                e = {
                    chart: {
                        height: 531,
                        type: "line",
                        dropShadow: {
                            enabled: !0,
                            opacity: .4,
                            blur: 8,
                            left: -7,
                            top: 8
                        }
                    },
                    markers: {
                        size: 5,
                        strokeColors: undefined,
                        strokeWidth: 2,
                        strokeOpacity: 0.9,
                        fillOpacity: 1,
                        radius: 1,
                        customHTML: undefined,
                        onClick: undefined,
                        offsetX: 0,
                        offsetY: 0,
                        
                    },
                    dataLabels: {
                        enabled: !1,
                        formatter: undefined,
                        textAnchor: 'middle',
                        offsetX: 1,
                        offsetY: 0,
                        style: {
                            fontSize: '22px', // Increase this value to increase the font size
                            colors: undefined
                        },
                    },
                    stroke: {
                        curve: "straight",
                        width: 4
                    },
                    series: [{
                        name: "ohne PVA",
                        data: arbeitsListe,
                        style: {
                            fontSize: '18px', // Increase this value to increase the font size
                            
                        },
                    }, {
                        name: "mit PVA",
                        data: restListe
                    }],
                    colors: t = e ? e.split(",") : t,
                    zoom: {
                        enabled: !0
                    },
                    xaxis: {
                        title: {
                            text: "Jahre"
                        },
                        type: "string",
                        categories: Array.from({length: zeitraum}, (_, i) => i + 1),
                        tooltip: {
                            enabled: !1
                        },
                        axisBorder: {
                            show: !1
                        }
                    },
                    yaxis: {
                        title: {
                            text: "Kosten in €"
                        },
                        labels: {
                            formatter: function(t) {
                                return t.toFixed(2);
                            },
                            offsetX: -5
                        }
                    },
                    legend: {
                        show: true,
                        labels: {
                            colors: undefined,
                            useSeriesColors: false,
                            formatter: undefined,
                            fontSize: '20px', // Increase this value for a larger font size
                            fontFamily: undefined,
                            cssClass: undefined,
                        }
                    },

                };
            new ApexCharts(document.querySelector("#revenue-statistics-chart"), e).render()
        }, n.CrmManagement = new t, n.CrmManagement.Constructor = t
    }(window.jQuery),
    function(e) {
        "use strict";
        e(document).ready(function(t) {
            e.CrmManagement.init()
        })
    }(window.jQuery)
</script>


{% comment %} 
<script>
document.addEventListener('DOMContentLoaded', function() {
    var anredeField = document.getElementById('id_anrede');
    var firstNameField = document.getElementById('tr_first_name');
    var lastNameLabel = document.querySelector('label[for="id_nachname"]');

    function updateFirstNameField() {
        if (anredeField.value === 'Firma') {
            firstNameField.setAttribute('hidden', true);
            lastNameLabel.textContent = 'Firma';
        } else {
            firstNameField.removeAttribute('hidden');
            lastNameLabel.textContent = 'Nachname';
        }
    }
    updateFirstNameField();
    anredeField.addEventListener('change', updateFirstNameField);
});
</script> {% endcomment %}

<script>
document.addEventListener("DOMContentLoaded", function() {
    
    const interessent = document.getElementById('id_name');
    const longitudeInput = document.getElementById('longitude');
    const latitudeInput = document.getElementById('latitude');
    var mapInitialized = false;
    var map, marker;
    var intervalId = null;

    function updateMapLink() {
        var lat = latitudeInput.value;
        var lon = longitudeInput.value;
        var link = document.getElementById('dynamicMapLink');
        if (lat && lon && link) {
            link.href = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}#map=14/${lat}/${lon}`;
        }
    }

    function initializeMap() {
        if (!mapInitialized && latitudeInput.value && longitudeInput.value) {
            document.getElementById('map').style.height = '550px';
            document.getElementById('map').style.width = '100%';

            map = L.map('map').setView([latitudeInput.value, longitudeInput.value], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            marker = L.marker([latitudeInput.value, longitudeInput.value]).addTo(map);
            mapInitialized = true;
        }
    }

    function pollForChanges() {
        var newLat = parseFloat(latitudeInput.value);
        var newLng = parseFloat(longitudeInput.value);
        var mapCenter = map.getCenter();

        // Calculate the difference between the map's center and the new coordinates
        var latDiff = Math.abs(mapCenter.lat - newLat);
        var lngDiff = Math.abs(mapCenter.lng - newLng);

        // Only update the map's view if the difference is significant (e.g., more than a small threshold)
        if ((latDiff > 0.0001 || lngDiff > 0.0001) && 
            (marker.getLatLng().lat !== newLat || marker.getLatLng().lng !== newLng)) {
            map.setView([newLat, newLng], map.getZoom());
            marker.setLatLng([newLat, newLng]);
        }
    }


    function startPollingInterval() {
        if (intervalId !== null) {
            clearInterval(intervalId);
        }
        intervalId = setInterval(pollForChanges, 3000);
    }

    interessent.addEventListener('input', pollForChanges);

    longitudeInput.addEventListener('change', updateMapLink);
    latitudeInput.addEventListener('change', updateMapLink);

    document.querySelector('a[href="#home-b1"]').addEventListener('shown.bs.tab', function(e) {
        updateMapLink();
        initializeMap();
    });
    

    initializeMap();
    setInterval(pollForChanges, 3000);
});
</script>


{% comment %} <script>
document.addEventListener("DOMContentLoaded", function() {
    const longitudeInput = document.getElementById('longitude');
    const latitudeInput = document.getElementById('latitude');
    document.getElementById('map').style.height = '550px';
    document.getElementById('map').style.width = '100%';
// Then initialize the map


    // Initialize the map
    var map = L.map('map').setView([latitudeInput.value, longitudeInput.value], 14);

    // Load and display tile layers on the map (from OpenStreetMap by default)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Marker
    var marker = L.marker([latitudeInput.value, longitudeInput.value]).addTo(map);
    // Call this when the container of the map is shown or resized
    







    function pollForChanges() {
        var newLat = parseFloat(latitudeInput.value);
        var newLng = parseFloat(longitudeInput.value);

        // Check if the current map center is different from the input values
        if(map.getCenter().lat !== newLat || map.getCenter().lng !== newLng ||
           marker.getLatLng().lat !== newLat || marker.getLatLng().lng !== newLng) {
            updateMap();
        }
    }

    // Update map function
    function updateMap() {
        console.log('Updating map with new coordinates');
        var newLat = parseFloat(latitudeInput.value);
        var newLng = parseFloat(longitudeInput.value);
        map.setView([newLat, newLng], 14);
        marker.setLatLng([newLat, newLng]);
        // Update your marker position if you have one
    }

    // Set up polling every 1000 milliseconds (1 second)
    setInterval(pollForChanges, 1000);
});

</script> {% endcomment %}
{% endblock %}

{% block extra_js %}
{% comment %} <script src="https://maps.google.com/maps/api/js"></script> {% endcomment %}
{% comment %} <script src="{% static 'assets/vendor/gmaps/gmaps.min.js' %}"></script> {% endcomment %}

        <!-- Google Maps Demo js -->
{% comment %} <script src="{% static 'assets/js/pages/demo.google-maps.js' %}"></script> {% endcomment %}
<script src="{% static 'assets/vendor/bootstrap-touchspin/jquery.bootstrap-touchspin.min.js' %}"></script>

<!-- Code Highlight js -->
<script src="{% static 'assets/vendor/highlightjs/highlight.pack.min.js' %}"></script>
<script src="{% static 'assets/vendor/clipboard/clipboard.min.js' %}"></script>
<script src="{% static 'assets/js/hyper-syntax.js' %}"></script>

<script src="{% static 'assets/vendor/apexcharts/apexcharts.min.js' %}"></script>
<script src="{% static 'assets/vendor/daterangepicker/moment.min.js' %}"></script>
        <!-- Chart.js-->
<script src="{% static 'assets/vendor/chart.js/chart.min.js' %}"></script>

        <!-- Chart.js Line Demo js -->
<script src="{% static 'assets/js/pages/demo.chartjs-line.js' %}"></script>  

<!-- Apex Chart Area Demo js -->
<script src="https://apexcharts.com/samples/assets/stock-prices.js"></script>
<script src="https://apexcharts.com/samples/assets/series1000.js"></script>
<script src="https://apexcharts.com/samples/assets/github-data.js"></script>
<script src="https://apexcharts.com/samples/assets/irregular-data-series.js"></script>
{% comment %} <script src="{% static 'assets/js/pages/demo.apex-area.js' %}"></script>   {% endcomment %}



<script src="{% static 'assets/vendor/dropzone/min/dropzone.min.js' %}"></script>
    <script src="{% static 'assets/vendor/jquery-mask-plugin/jquery.mask.min.js' %}"></script>

    <!-- Daterangepicker Plugin js -->
    <script src="{% static 'assets/vendor/daterangepicker/moment.min.js' %}"></script>
    <script src="{% static 'assets/vendor/daterangepicker/daterangepicker.js' %}"></script>

    <!-- Bootstrap Datepicker Plugin js -->
    <script src="{% static 'assets/vendor/bootstrap-datepicker/js/bootstrap-datepicker.min.js' %}"></script>

    <!-- Bootstrap Timepicker Plugin js -->
    <script src="{% static 'assets/vendor/bootstrap-timepicker/js/bootstrap-timepicker.min.js' %}"></script>

    <!-- Bootstrap Touchspin Plugin js -->
    <script src="{% static 'assets/vendor/bootstrap-touchspin/jquery.bootstrap-touchspin.min.js' %}"></script>

    <!-- Bootstrap Maxlength Plugin js -->
    <script src="{% static 'assets/vendor/bootstrap-maxlength/bootstrap-maxlength.min.js' %}"></script>

    <!-- Typehead Plugin js -->
    <script src="{% static 'assets/vendor/handlebars/handlebars.min.js' %}"></script>
    <script src="{% static 'assets/vendor/typeahead.js/typeahead.bundle.min.js' %}"></script>

    <!-- Flatpickr Timepicker Plugin js -->
    <script src="{% static 'assets/vendor/flatpickr/flatpickr.min.js' %}"></script>

    <!-- Demo js -->
    {% comment %} <script src="{% static 'assets/js/pages/demo.typehead.js' %}"></script> {% endcomment %}
    <script src="{% static 'assets/js/pages/demo.timepicker.js' %}"></script>

    <!-- Init js -->
    <script src="{% static 'assets/js/ui/component.fileupload.js' %}"></script>  
    <script src="{% static 'assets/js/vendor.min.js' %}"></script>
    <script src="{% static 'assets/vendor/highlightjs/highlight.pack.min.js' %}"></script>
    <script src="{% static 'assets/vendor/clipboard/clipboard.min.js' %}"></script>
    <script src="{% static 'assets/js/hyper-syntax.js' %}"></script>
    <script src="{% static 'assets/vendor/admin-resources/jquery.vectormap/jquery-jvectormap-1.2.2.min.js' %}"></script>
    <script src="{% static 'assets/vendor/admin-resources/jquery.vectormap/maps/jquery-jvectormap-world-mill-en.js' %}"></script>
    <script src="{% static 'assets/vendor/select2/js/select2.min.js' %}"></script>
    

        <!-- Apex Charts js -->
<script src="{% static 'assets/vendor/apexcharts/apexcharts.min.js' %}"></script>                                       
    <!-- Vector Map js -->
<script src="{% static 'assets/vendor/admin-resources/jquery.vectormap/jquery-jvectormap-1.2.2.min.js' %}"></script>
<script src="{% static 'assets/vendor/admin-resources/jquery.vectormap/maps/jquery-jvectormap-world-mill-en.js' %}"></script>

    <!-- App js -->
<script src="{% static 'assets/js/app.min.js' %}"></script>
{% endblock %}
 
</div>
                        <div class="col-md-6">
                            <div class="text-md-end footer-links d-none d-md-block">
                                <a type="submit" href="javascript:void(0)" id="send_support_message">Support</a>
                            </div>
                        </div>
                    </div>
                </div>
            </footer>
            <div class="d-print-none mt-4">
                <div class="text-end">
                    <div id="success-alert-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
                        <div class="modal-dialog modal-sm">
                            <div class="modal-content modal-filled bg-success">
                                <div class="modal-body p-4">
                                    <div class="text-center">
                                        <i class="ri-check-line h1"></i>
                                        <h4 class="mt-2">Gut gemacht!</h4>
                                        <p class="mt-3">Email support message wurde erfolgreich versendet!</p>
                                        <button type="button" class="btn btn-light my-2" data-bs-dismiss="modal">Weiter</button>
                                    </div>
                                </div>
                            </div><!-- /.modal-content -->
                        </div><!-- /.modal-dialog -->
                    </div>
                </div>
            </div>
            <script>