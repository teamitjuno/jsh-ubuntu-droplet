{% extends 'vertrieb/base.html' %}
{% load static %}
{% load i18n %}
{% load widget_tweaks %}
{% block content %}
{% load custom_filter %}

<div class="content-page">
    <div class="content">
        {% if vertrieb_ticket.ticket_id %}
            {% if not vertrieb_ticket.is_locked and vertrieb_ticket.status != "angenommen" %}
        <form class="needs-validation" novalidate id="main-form" method="POST" action="{% url 'vertrieb_interface:edit_ticket_new' ticket_id=vertrieb_ticket.ticket_id %}">
            {% csrf_token %}
                <div class="container-fluid">
                {% if form.errors %}
                    <div class="row">
                        <div class="col-xl-12">
                            <div class="card m-3">
                                <div class="card-body border-primary border">     
                                    <div class="alert alert-danger">Fehler :
                                        
                                        {% if form.non_field_errors %}
                                            <div class="error">
                                                {% for error in form.non_field_errors %}
                                                <p>{{ error }}</p>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        <ul>
                                            {% for field in form %}
                                                {% if field.errors %}
                                                    <li>{{ field.label }} - {{ field.errors.0 }}</li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                        {% if messages %}
                                                <ul class="messages">
                                                    {% for message in messages %}
                                                        <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
                                                    {% endfor %}
                                                </ul>
                                            {% endif %}
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %} 

                    <div class="row">
                        <div class="col-12">
                            <div class="page-title-box">
                                <div class="page-title-right"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xl-12">
                            <div class="card">
                                <div class="card-body border-primary border">
                                        <ul class="nav nav-tabs nav-justified nav-bordered mb-4" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <a href="#info" data-bs-toggle="tab" aria-expanded="true" class="nav-link active" aria-selected="false" role="tab">
                                                    <i class="mdi mdi-home-variant d-md-none d-block"></i>
                                                    <span class="d-none d-md-block h4">Info</span>
                                                </a>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <a href="#zubehoer" onclick=toggleActiveTabFeature() data-bs-toggle="tab" aria-expanded="true" class="nav-link" aria-selected="true" tabindex="-1" role="tab">
                                                    <i class="mdi mdi-panorama-sphere-outline d-md-none d-block"></i>
                                                    <span class="d-none d-md-block h4">Zubehör</span>
                                                </a>
                                            </li>
                                            {% if vertrieb_ticket.status == "angenommen" %}
                                            <li hidden class="nav-item" role="presentation">
                                                <a href="#ticket" data-bs-toggle="tab" aria-expanded="true" class="nav-link" aria-selected="false" tabindex="-1" role="tab">
                                                    <i class="mdi mdi-altimeter d-md-none d-block"></i>
                                                    <span class="d-none d-md-block h4">Ticket</span>
                                                </a>
                                            </li>
                                            {% endif %}
                                        </ul>
                                    <div class="tab-content">
                                        <div class="tab-pane show active" id="info" role="presentation">
                                            <div class="card-body">
                                                <div class="row">
                                                    <!-- Column 1 -->
                                                    <div class="col-lg-6">
                                                        <div class="card mb-3">
                                                        <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Interessenteninfo</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tbody>
                                                                        <tr hidden>
                                                                            <th></th>
                                                                            <td hidden>
                                                                                <div class="custom-control custom-switch">
                                                                                    <input type="checkbox" class="custom-control-input" id="switch10" {% if form.is_locked.value %}checked{% endif %} data-switch="success" name="{{ form.is_locked.html_name }}"/>
                                                                                    <label class="custom-control-label" for="switch10" data-on-label="Yes" data-off-label="No"></label>
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                        <tr hidden>
                                                                            <th>{{ form.zoho_id.label_tag }}</th>
                                                                            <td>{{ form.zoho_id }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.name.label_tag }}</th>
                                                                            <td>
                                                                                {{ form.name }}
                                                                                <div class="invalid-tooltip">
                                                                                    Wählen Sie einen Interessent
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                         <tr hidden>
                                                                            <th>{{ form.angenommenes_angebot.label_tag }}</th>
                                                                            <td>{{ form.angenommenes_angebot }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.anrede.label_tag }}</th>
                                                                            <td> {{ form.anrede }}</td>
                                                                        </tr>
                                                                        <tr hidden>
                                                                            <th>{{ form.vorname_nachname.label_tag }}</th>
                                                                            <td>{{ form.vorname_nachname }}
                                                                                
                                                                            </td>
                                                                        </tr>
                                                                        <tr hidden>
                                                                            <th>{{ form.name_suffix.label_tag }}</th>
                                                                            <td>{{ form.name_suffix }}
                                                                                
                                                                            </td>
                                                                        </tr>
                                                                        <tr id="tr_first_name">
                                                                            <th>{{ form.name_first_name.label_tag }}</th>
                                                                            <td>{{ form.name_first_name }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.name_last_name.label_tag }}</th>
                                                                            <td>{{ form.name_last_name }}
                                                                                
                                                                            </td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.telefon_mobil.label_tag }}</th>
                                                                            <td>{{ form.telefon_mobil }}
                                                                               
                                                                            </td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.telefon_festnetz.label_tag }}</th>
                                                                            <td>{{ form.telefon_festnetz }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.email.label_tag }}</th>
                                                                            <td>{{ form.email }}
                                                                                
                                                                            </td>
                                                                        </tr>
                                                                        <tr hidden>
                                                                            <th>{{ form.firma.label_tag }}</th>
                                                                            <td>{{ form.firma }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.strasse.label_tag }}</th>
                                                                            <td>{{ form.strasse }}
                                                                           
                                                                            </td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.ort.label_tag }}</th>
                                                                            <td>{{ form.ort }}
                                                                            
                                                                            </td>
                                                                        </tr>
                                                                        <tr>                                                                            
                                                                            <th>{{ form.postanschrift_name.label_tag }}</th>
                                                                            <td>{{ form.postanschrift_name }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.postanschrift.label_tag }}</th>
                                                                            <td>{{ form.postanschrift }}</td>                                                                            
                                                                            <td hidden><input type="text" id="longitude" name="postanschrift_longitude" value="{{ form.postanschrift_longitude.value }}"></td>
                                                                            <td hidden><input type="text" id="latitude" name="postanschrift_latitude" value="{{ form.postanschrift_latitude.value }}"></td>
                                                                        </tr>
                                                                        <tr>                                                                            
                                                                            <th>{{ form.postanschrift_ort.label_tag }}</th>
                                                                            <td>{{ form.postanschrift_ort }}</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div><!-- End of row -->
                                            </div>
                                        </div>
                                        <div class="tab-pane" id="zubehoer" role="presentation">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-lg-4">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Module</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tr>
                                                                        <th>{{ form.solar_module.label_tag }}</th>
                                                                        <td>{{ form.solar_module }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.modulanzahl.label_tag }}</th>
                                                                        <td id="modulanzahl" name="modulanzahl" data-bs-toggle="tooltip">
                                                                            {{ form.modulanzahl }}
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Modulleistung</th>
                                                                        <td id="modulleistungWp" name="modulleistungWp">{{ vertrieb_ticket.modulleistungWp }} Wp</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Modulsumme inkl. Originalangebot</th>
                                                                        <td id="modulsumme_kWp" name="modulsumme_kWp">{{ vertrieb_ticket.modulsumme_kWp }} kWp</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.anzOptimizer.label_tag }}</th>
                                                                        <td id="anzOptimizer" name="anzOptimizer" data-bs-toggle="tooltip">
                                                                            {{ form.anzOptimizer }}
                                                                        </td>
                                                                    </tr>
                                                                </table>
                                                            </div>
                                                        </div>
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Wechselrichter & Speicher</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tr>
                                                                        <th>{{ form.speicher_model.label_tag }}</th>
                                                                        <td>{{ form.speicher_model }}</td>
                                                                    </tr>

                                                                    <tr>
                                                                        <th>{{ form.anz_speicher.label_tag }}</th>
                                                                        <td>{{ form.anz_speicher }}</td>
                                                                        
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Gesamtkapazität inkl. Originalangebot</th>
                                                                        <td>{{ vertrieb_ticket.gesamtkapazitat }} kWh</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.smartmeter_model.label_tag }}</th>
                                                                        <td>{{ form.smartmeter_model }}</td>
                                                                    </tr>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-4">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Zubehör</div>
                                                            <div class="card-body">
                                                                 <table class="table table-sm table-hover">
                                                                    <tr>
                                                                        <th>{{ form.smartDongleLte.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="smartDongleLte" {% if form.smartDongleLte.value %}checked{% endif %} data-switch="success" name="{{ form.smartDongleLte.html_name }}" />
                                                                                <label class="custom-control-label" for="smartDongleLte" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr id="bool_elwa_row">
                                                                        <th>{{ form.elwa.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="elwa" {% if form.elwa.value %}checked{% endif %} data-switch="success" name="{{ form.elwa.html_name }}" />
                                                                                <label class="custom-control-label" for="elwa" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.thor.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="thor" {% if form.thor.value %}checked{% endif %} data-switch="success" name="{{ form.thor.html_name }}" />
                                                                                <label class="custom-control-label" for="thor" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr id="heizstab_row" class="conditional-row">
                                                                        <th>{{ form.heizstab.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="heizstab-checkbox" {% if form.heizstab.value %}checked{% endif %} data-switch="success" name="{{ form.heizstab.html_name }}" />
                                                                                <label class="custom-control-label" for="heizstab-checkbox" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr hidden>
                                                                        <th>{{ form.wandhalterung_fuer_speicher.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="switch31" {% if form.wandhalterung_fuer_speicher.value %}checked{% endif %} data-switch="success" name="{{ form.wandhalterung_fuer_speicher.html_name }}" />
                                                                                <label class="custom-control-label" for="switch31" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr id="anz_wandhalterung_row" class="conditional-row">
                                                                        <th>{{ form.anz_wandhalterung_fuer_speicher.label_tag }}</th>
                                                                        <td>
                                                                            <input type="number" id="anz_wandhalterung_fuer_speicher" class="form-control" name="{{ form.anz_wandhalterung_fuer_speicher.html_name }}" value="{{ form.anz_wandhalterung_fuer_speicher.value }}" />
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.apzFeld.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="apzFeld" {% if form.apzFeld.value %}checked{% endif %} data-switch="success" name="{{ form.apzFeld.html_name }}" />
                                                                                <label class="custom-control-label" for="apzFeld" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.apzFeldUVV.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="apzFeldUVV" {% if form.apzFeldUVV.value %}checked{% endif %} data-switch="success" name="{{ form.apzFeldUVV.html_name }}" />
                                                                                <label class="custom-control-label" for="apzFeldUVV" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.zaehlerschrank.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="zaehlerschrank" {% if form.zaehlerschrank.value %}checked{% endif %} data-switch="success" name="{{ form.zaehlerschrank.html_name }}" />
                                                                                <label class="custom-control-label" for="zaehlerschrank" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr hidden>
                                                                        <th>{{ form.potentialausgleich.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="potentialausgleich" {% if form.potentialausgleich.value %}checked{% endif %} data-switch="success" name="{{ form.potentialausgleich.html_name }}" />
                                                                                <label class="custom-control-label" for="potentialausgleich" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.beta_platte.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="beta_platte" {% if form.beta_platte.value %}checked{% endif %} data-switch="success" name="{{ form.beta_platte.html_name }}" />
                                                                                <label class="custom-control-label" for="beta_platte" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.metall_ziegel.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="metall_ziegel" {% if form.metall_ziegel.value %}checked{% endif %} data-switch="success" name="{{ form.metall_ziegel.html_name }}" />
                                                                                <label class="custom-control-label" for="metall_ziegel" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.prefa_befestigung.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="prefa_befestigung" {% if form.prefa_befestigung.value %}checked{% endif %} data-switch="success" name="{{ form.prefa_befestigung.html_name }}" />
                                                                                <label class="custom-control-label" for="prefa_befestigung" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.geruestKunde.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="geruestKunde" {% if form.geruestKunde.value %}checked{% endif %} data-switch="success" name="{{ form.geruestKunde.html_name }}" />
                                                                                <label class="custom-control-label" for="geruestKunde" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr id="geruestOeff_row" class="conditional-row">
                                                                        <th>{{ form.geruestOeffentlich.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="geruestOeffentlich" {% if form.geruestOeffentlich.value %}checked{% endif %} data-switch="success" name="{{ form.geruestOeffentlich.html_name }}" />
                                                                                <label class="custom-control-label" for="geruestOeffentlich" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.dachhakenKunde.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="dachhakenKunde" {% if form.dachhakenKunde.value %}checked{% endif %} data-switch="success" name="{{ form.dachhakenKunde.html_name }}" />
                                                                                <label class="custom-control-label" for="dachhakenKunde" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                 </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-4">
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Wallbox</div>
                                                            <div class="card-body">
                                                                 <table class="table table-sm table-hover">
                                                                    <tr hidden>
                                                                        <th>{{ form.wallbox.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="wallbox-checkbox" {% if form.wallbox.value %}checked{% endif %} data-switch="success" name="{{ form.wallbox.html_name }}" />
                                                                                <label class="custom-control-label" for="wallbox-checkbox" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.wallboxtyp.label_tag }}</th>
                                                                        <td>{{ form.wallboxtyp }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.wallbox_anzahl.label_tag }}</th>
                                                                        <td>{{ form.wallbox_anzahl }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.midZaehler.label_tag }}</th>
                                                                        <td>{{ form.midZaehler }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.kabelanschluss.label_tag }}</th>
                                                                        <td>{{ form.kabelanschluss }}</td>
                                                                    </tr>
                                                                 </table>
                                                            </div>
                                                        </div>
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Ersatzstromversorgung</div>
                                                            <div class="card-body">
                                                                 <table class="table table-sm table-hover">
                                                                    <tr>
                                                                        <th>{{ form.notstrom.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="switch04" {% if form.notstrom.value %}checked{% endif %} data-switch="success" name="{{ form.notstrom.html_name }}" />
                                                                                <label class="custom-control-label" for="switch04" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.ersatzstrom.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="ersatzstrom" {% if form.ersatzstrom.value %}checked{% endif %} data-switch="success" name="{{ form.ersatzstrom.html_name }}" />
                                                                                <label class="custom-control-label" for="ersatzstrom" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr id="kabelSmartGuard_row" class="conditional-row">
                                                                        <th>{{ form.kabelSmartGuard.label_tag }}</th>
                                                                        <td>{{ form.kabelSmartGuard }}</td>
                                                                    </tr>
                                                                 </table>
                                                            </div>
                                                        </div>
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Gesamtpreis Nachverkauf</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    {% if user.role.name == "admin" or user.role.name == "manager" %}
                                                                    <tr>
                                                                        <th>{{ form.rabatt.label_tag }}</th>
                                                                        <td>
                                                                            <input type="number" id="rabatt" class="form-control" name="{{ form.rabatt.html_name }}" value="{{ form.rabatt.value }}" />
                                                                        </td>
                                                                    </tr>
                                                                    <tr id="ausweisung_row" class="conditional-row">
                                                                        <th>{{ form.ausweisung_rabatt.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="ausweisung_rabatt" {% if form.ausweisung_rabatt.value %}checked{% endif %} data-switch="success" name="{{ form.ausweisung_rabatt.html_name }}" />
                                                                                <label class="custom-control-label" for="ausweisung_rabatt" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr id="wp_kombi_row" class="conditional-row">
                                                                        <th>{{ form.wp_kombi_rabatt.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="wp_kombi_rabatt" {% if form.wp_kombi_rabatt.value %}checked{% endif %} data-switch="success" name="{{ form.wp_kombi_rabatt.html_name }}" />
                                                                                <label class="custom-control-label" for="wp_kombi_rabatt" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>{{ form.sonderrabatt_included.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="switch_sonderrabatt" {% if form.sonderrabatt_included.value %}checked{% endif %} data-switch="success" name="{{ form.sonderrabatt_included.html_name }}" />
                                                                                <label class="custom-control-label" for="switch_sonderrabatt" data-on-label="Ja" data-off-label="Nein"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr id="sonderrabatt_row" class="conditional-row">
                                                                        <th>{{ form.sonderrabatt.label_tag }}</th>
                                                                        <td>{{ form.sonderrabatt }}</td>
                                                                    </tr>
                                                                    <script type="text/javascript">
                                                                        $(document).ready(function() {
                                                                            updateSonderrabattRow();
                                                                            toggleGenehmigung($('#rabatt').val());
                                                                            // On 'Finanzierung' checkbox state change
                                                                            $('#switch_sonderrabatt').change(function() {
                                                                                updateSonderrabattRow();
                                                                            });
                                                                            function updateSonderrabattRow() {
                                                                                if ($('#switch_sonderrabatt').is(':checked')) {
                                                                                    // If checkbox is checked, show 'Inddiv Preis' row
                                                                                    $('#sonderrabatt_row').show();
                                                                                } else {
                                                                                    // If checkbox is not checked, hide 'Inddiv Preis' row
                                                                                    $('#sonderrabatt_row').hide();
                                                                                }
                                                                            }
                                                                            function toggleGenehmigung(value){
                                                                                if (value > 0) {
                                                                                    $('#ausweisung_row').show();
                                                                                    $('#wp_kombi_row').show();
                                                                                } else {
                                                                                    $('#ausweisung_row').hide();
                                                                                     $('#wp_kombi_row').hide();
                                                                                    {% if user.role.name == "admin" %}
                                                                                    if (document.getElementById('switch_indiv_price_included').checked){
                                                                                        $('#wp_kombi_row').show();
                                                                                    }
                                                                                    {% endif %}
                                                                                }
}
                                                                        });
                                                                    </script>
                                                                    {% endif %}
                                                                    <tr>
                                                                        <th>Preis Netto</th>
                                                                        <td class="text-success-emphasis">{{ vertrieb_ticket.angebotsumme|format_price }}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Preis Brutto</th>
                                                                        <td class="text-success-emphasis">{{ vertrieb_ticket.kosten_pva|format_price }}</td>
                                                                    </tr>
                                                                </table>
                                                            </div>
                                                        </div>
                                                        {% if user.role.name == "admin" %}
                                                        <div class="card mb-3">
                                                            <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Individual Preis</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tr>
                                                                        <th>{{ form.indiv_price_included.label_tag }}</th>
                                                                        <td>
                                                                            <div class="custom-control custom-switch">
                                                                                <input type="checkbox" class="custom-control-input" id="switch_indiv_price_included" {% if form.indiv_price_included.value %}checked{% endif %} data-switch="success" name="{{ form.indiv_price_included.html_name }}" />
                                                                                <label class="custom-control-label" for="switch_indiv_price_included" data-on-label="Yes" data-off-label="No"></label>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <tr id="indiv_price_row">
                                                                        <th>{{form.indiv_price.label_tag }}</th>
                                                                        <td>{{ form.indiv_price }}</td>
                                                                    </tr>
                                                                    <tr id="indiv_text_row">
                                                                        <th>{{form.indiv_text.label_tag }}</th>
                                                                        <td>{{ form.indiv_text }}</td>
                                                                    </tr>
                                                                </table>
                                                                <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
                                                                <script type="text/javascript">
                                                                    $(document).ready(function() {
                                                                        // Initial state of 'Inddiv Preis' row
                                                                        updateIndivPreisRow();
                                                                        // On 'Indiv Preis inkl.' checkbox state change
                                                                        $('#switch_indiv_price_included').change(function() {
                                                                            updateIndivPreisRow();
                                                                        });
                                                                        function updateIndivPreisRow() {
                                                                            if ($('#switch_indiv_price_included').is(':checked')) {
                                                                                // If checkbox is checked, show 'Inddiv Preis' row
                                                                                $('#indiv_price_row').show();
                                                                                $('#indiv_text_row').show();
                                                                            } else {
                                                                                // If checkbox is not checked, hide 'Inddiv Preis' row
                                                                                $('#indiv_price_row').hide();
                                                                                $('#indiv_text_row').hide();
                                                                            }
                                                                        }
                                                                    });
                                                                </script>
                                                            </div>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </div> 
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xxl-6">
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="card widget-flat">
                                        <div class="card-body border-info border">
                                         <input type="hidden" name="action_type" id="actionType" value="">
                                                                                                        <script>
                                                            function setActionType(value) {
                                                                document.getElementById('actionType').value = value;
                                                            }
                                                        </script>
                                            <h5 class="text-muted fw-normal mt-0" title="Number of Orders">verfügbare Aktionen:</h5>

                                                    <script>
                                                        function showSpinner() {
                                                            var spinner = document.querySelector('.spinner-border');
                                                            if (spinner.style.display === 'none' || spinner.style.display === '') {
                                                                spinner.style.display = 'inline-block';
                                                            }
                                                        }
                                                    </script>
                                                    <div class="row m-2">
                                                        <button type="submit" onclick=submitFormWithAction('angebotsumme_rechnen') class="btn btn-soft-info rounded-pill">Ticket Summe rechnen</button>
                                                    </div>
                                                    <div class="row m-2">
                                                        
                                                        <button type="submit" onclick=submitFormWithAction('save') class="btn btn-soft-success rounded-pill">Speichern</button>

                                                    </div>
                                                    <div class="d-flex align-items-center">
                                                            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true" style="display: none;"></span>
                                                            </div>
                                                        <button hidden type="submit" onclick=submitFormWithAction('save') id="save-all-forms" class="btn btn-soft-success rounded-pill" >Speichern</button>

                                                
                                                    <div class="row m-2">
                                                        <button type="button" id="pdf_erstellen" data-bs-toggle="modal" data-bs-target="#info-alert-modal" class="btn btn-outline-info rounded-pill">Ticket PDF erstellen</button>
                                                        
                                                    </div>
                                                    <div id="info-alert-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
                                                        <div class="modal-dialog modal-dialog-centered">
                                                            <div class="modal-content">
                                                                <div class="modal-body p-4">
                                                                    <div class="text-center">
                                                                        <i class="ri-information-line h1 text-info"></i>
                                                                        <h4 class="mt-2">Achtung!</h4>
                                                                        <p class="mt-3">Diese Aktion setzt den Status des Angebots automatisch auf "bekommen" und leitet Sie zur PDF-Seite des Angebots weiter. Wollen Sie das fortsetzen?"</p>
                                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                                                                            
                                                                            <button type="submit" onclick=submitFormWithAction('switch_to_bekommen') id="continueButtonn" class="btn btn-info my-2" data-bs-dismiss="modal">Weiter...</button>
                                                                    </div>
                                                                </div>
                                                            </div><!-- /.modal-content -->
                                                        </div><!-- /.modal-dialog -->
                                                    </div>
                                                    <div id="info-alert-modal2" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
                                                        <div class="modal-dialog modal-dialog-centered">
                                                            <div class="modal-content">
                                                                <div class="modal-body p-4">
                                                                    <div class="text-center">
                                                                        <i class="ri-information-line h1 text-info"></i>
                                                                        <h4 class="mt-2">Achtung!</h4>
                                                                        <p class="mt-3">Diese Aktion setzt den Status des Angebots automatisch auf "bekommen" und leitet Sie zur PDF-Seite des Angebots weiter. Wollen Sie das fortsetzen?"</p>
                                                                        
                                                                            
                                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                                                                            <button type="submit" onclick=submitFormWithAction('switch_to_bekommen_pdf_plus_kalk') id="continueButtonnn" class="btn btn-info my-2" data-bs-dismiss="modal">Weiter...</button>
                                                                    </div>
                                                                </div>
                                                            </div><!-- /.modal-content -->
                                                        </div><!-- /.modal-dialog -->


                                                                                                                <script>
                                                            document.addEventListener('DOMContentLoaded', function () {
                                                                var pdfButton = document.getElementById('pdf_erstellen');
                                                                var pdfButton2 = document.getElementById('pdf_and_calc_erstellen');
                                                                var pdfButton3 = document.getElementById('continueButtonn');
                                                                var pdfButton4 = document.getElementById('continueButtonnn');

                                                                pdfButton4.addEventListener('click', function() {
                                                                    this.disabled = true; // Disable the button
                                                                    this.classList.add('disabled'); // Optional: Add a class to change the appearance
                                                                    pdfButton2.disabled = true; // Disable the second button
                                                                    pdfButton2.classList.add('disabled'); // Optional: Add a class for the second button
                                                                });

                                                                // If you want similar functionality for pdfButton2, add an event listener here
                                                                pdfButton3.addEventListener('click', function() {
                                                                    this.disabled = true;
                                                                    this.classList.add('disabled');
                                                                    pdfButton.disabled = true; // Disable the second button
                                                                    pdfButton.classList.add('disabled'); // Optional: Add a class for the second button
                                                                    // Add any other functionality you need for pdfButton2
                                                                });
                                                            });

                                                        </script>
                                                    </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="card widget-flat">
                                        <div class="card-body border-info border">
                                            <h5 class="text-muted fw-normal mt-0">Kundennummer {{ vertrieb_ticket.zoho_kundennumer}}</h5>
                                            <h5 class="text-muted fw-normal mt-0" title="Number of Customers">Nachverkauf ID</h5>
                                            <h3 class="mt-3 mb-3">{{ vertrieb_ticket.ticket_id}}</h3>
                                            {% if vertrieb_ticket.countdown %}
                                            <span class="text-nowrap h4"> läuft in  </span><span class="text-danger me-2 text-nowrap h4">{{ vertrieb_ticket.countdown }}</span><span class="text-nowrap h4"> ab.</span>
                                            <p></p>
                                            {% endif %}
                                            <p class="mb-0 text-muted">
                                                {% if not vertrieb_ticket.is_locked %}
                                                    <span class="text-success me-2"></i> Verfügbar</span>
                                                {% else %}
                                                    <span class="text-danger me-2"></i> Nicht verfügbar</span>
                                                {% endif %}    
                                                    <span class="text-nowrap">Zugriff auf die Bearbeitung</span>  
                                            </p>
                                        </div> 
                                    </div> 
                                </div>
                                <div hidden class="col-sm-6">
                                    <div class="card widget-flat">
                                        <div class="card-body">
                                            {% if vertrieb_ticket.status == 'bekommen' %} 
                                            <div class="float-end">
                                                <button name="change_status_button" id="changeStatusButton" class="btn btn-soft-success rounded-pill" type="submit">finalisieren</button>
                                            </div>
                                            {% endif %}
                                            <h5 class="text-muted fw-normal mt-0" title="Number of Orders">{{ vertrieb_ticket.anfrage_vom }}</h5>
                                            <p></p>
                                            {% if not vertrieb_ticket.is_locked %}
                                                <h4 class="text-muted fw-normal mt-0" title="Number of Orders">{{ form.status.label_tag}}:</h4>
                                                <h4 hidden>{{ form.status }}</h4>
                                                <input type="text" readonly class="form-control-plaintext h2" id="id_status" value="{{ form.status.value }}">
                                            {% else %}
                                                <h4 class="text-muted fw-normal mt-0" title="Number of Orders">{{ form.status.label_tag}}:</h4>
                                                <h4 hidden>{{ form.status }}</h4>
                                                <input type="text" readonly class="form-control-plaintext h2" id="id_status" value="{{ form.status.value }}">
                                                
                                            {% endif %}
                                            {% if vertrieb_ticket.status == 'bekommen' %} 
                                            <p class="mb-0 text-muted">
                                                    <span class="text-success me-2"></i> {{ vertrieb_ticket.status_change_field }}</span>
                                                    <span class="text-nowrap">Änderungsdatum</span>
                                            </p>
                                            {% endif %}
                                        </div> 
                                    </div> 
                                </div>
                            </div>
                        </div>
                        <div class="col-xxl-6">
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="card widget-flat">
                                        <div class="card-body border-info border">
                                            <h5 class="text-muted fw-normal mt-0" title="Number of Orders">Angenommenes Angebot</h5>
                                            <table class="table table-sm table-hover">
                                                <tbody>
                                                    <tr>
                                                        <th> Angebot ID</th>
                                                        <td>{{ vertrieb_ticket.angenommenes_angebot }}</td>
                                                    </tr>
                                                    <tr>
                                                        <th> Status PVA</th>
                                                        <td>{{ vertrieb_ticket.status_pva }}</td>
                                                    </tr>
                                                    <tr>
                                                        <th> Bauteile</th>
                                                        <td>{{ vertrieb_ticket.bauteile_finder|linebreaks }}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div> 
                                    </div> 
                                </div> 
                                <div class="col-sm-6">
                                    <div class="card widget-flat">
                                        <div class="card-body border-info border">
                                            <table class="table table-sm table-hover">
                                                <tr>
                                                    <th>Preis Netto</th>
                                                    <td class="text-success-emphasis">{{ vertrieb_ticket.angebotsumme|format_price }}</td>
                                                </tr>
                                                <tr>
                                                    <th>Preis Brutto</th>
                                                    <td class="text-success-emphasis">{{ vertrieb_ticket.kosten_pva|format_price }}</td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div> 
        </form>
                
<script>
$(document).ready(function() {
    toggleAnzWandhalterung($('#hersteller').val());
    toggleHeizstab(document.getElementById('thor').checked);
    {#toggleKabelSmartGuard(document.getElementById('ersatzstrom').checked);#}
    toggleGeruestOeff(document.getElementById('geruestKunde').checked);
    setFieldOptions();
});

function toggleHeizstab(value){
    if (value === true) {
        $('#heizstab_row').show();
    } else {
        $('#heizstab_row').hide();
    }
}

function toggleKabelSmartGuard(value){
    if (value === true) {
        $('#kabelSmartGuard_row').show();
    } else {
        $('#kabelSmartGuard_row').hide();
    }
}

function toggleGeruestOeff(value){
    if (value === false) {
        $('#geruestOeff_row').show();
    } else {
        $('#geruestOeff_row').hide();
    }
}

function setFieldOptions(value) {
    var speicherOptions, smartmeterOptions;
    
        if($('#speicher_model').val() == "LUNA 2000-5-S0"){
            speicherOptions = '<option value="LUNA 2000-5-S0">LUNA 2000-5-S0</option><option value="LUNA 2000-7-S1">LUNA 2000-7-S1</option>';
        }
        else {
            speicherOptions = '<option value="LUNA 2000-7-S1">LUNA 2000-7-S1</option><option value="LUNA 2000-5-S0">LUNA 2000-5-S0</option>';
        }
        if($('#smartmeter_model').val() == "Smart Power Sensor DTSU666H"){
            smartmeterOptions = '<option value="Smart Power Sensor DTSU666H">Smart Power Sensor DTSU666H</option><option value="EMMA-A02">EMMA-A02</option><option value="kein EMS">kein EMS</option>';
        }
        else if($('#smartmeter_model').val() == "EMMA-A02"){
            smartmeterOptions = '<option value="EMMA-A02">EMMA-A02</option><option value="Smart Power Sensor DTSU666H">Smart Power Sensor DTSU666H</option><option value="kein EMS">kein EMS</option>';
        }
        else {
            smartmeterOptions = '<option value="kein EMS">kein EMS</option><option value="EMMA-A02">EMMA-A02</option><option value="Smart Power Sensor DTSU666H">Smart Power Sensor DTSU666H</option>';
        }
        $("#speicher_model").html(speicherOptions);
        $("#smartmeter_model").html(smartmeterOptions);
}

function toggleAnzWandhalterung(value) {
    if (value === 'Viessmann') {
        $('#anz_wandhalterung_row').hide();
        $('#bool_elwa_row').hide();
    } else {
        $('#anz_wandhalterung_row').show();
        $('#bool_elwa_row').show();
    }
}

function limitModulanzahl(maxValue) {
    $('#modulanzahl').change(function() {
        var value = parseInt($(this).val());
        if (value > maxValue) {
            alert('Modulanzahl cannot be more than ' + maxValue + ' when Hersteller is Viessmann.');
            $(this).val(maxValue);
        }
    });
}

function submitFormWithAction(actionType) {
    document.getElementById('actionType').value = actionType;
    document.getElementById('main-form').submit();
}
</script>
                

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const excludeSelector = ':not([name="hersteller"]):not([name="anrede"]):not([name="name_first_name"]):not([name="name_last_name"]):not([name="telefon_mobil"]):not([name="telefon_festnetz"]):not([name="email"]):not([name="strasse"]):not([name="ort"]):not([name="name_suffix"]):not([name="monatliche_rate"]):not([name="laufzeit"]):not([name="sollzinssatz"]):not([name="effektiver_zins"]):not([name="gesamtkreditbetrag"])';
    const formFields = document.querySelectorAll('.table input' + excludeSelector + ', .table select' + excludeSelector + ', .table .custom-control-input' + excludeSelector);

    const onChange = () => {
        submitFormWithAction('angebotsumme_rechnen');
    };

    formFields.forEach(field => {
        field.addEventListener('change', onChange);
    });
});

function submitFormWithAction(action) {
    console.log(`Action to perform: ${action}`);
}
</script>
                <!--- Locked state starting here --->
    {% else %}
        <form id="main-form" method="POST" onsubmit="updateDisplay();" action="{% url 'vertrieb_interface:edit_ticket_new' ticket_id=vertrieb_ticket.ticket_id %}">
            {% csrf_token %}
            <div class="container-fluid">     
                {% if form.errors %}
                <div class="alert alert-danger">Please correct the following errors:
                    <ul>
                        {% for field in form %}
                            {% if field.errors %}
                                <li>{{ field.label }} - {{ field.errors.0 }}</li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </div>
                    {% endif %}
                <div class="row">
                    <div class="col-7">
                        <div class="page-title-box">
                            {% if user.role.name == "admin" %}
                                <h4 class="page-title">Juno Solar Vertriebsportal : {{ user.role.name }}</h4>
                            {% else %}
                                <h4 class="page-title">Juno Solar Vertriebsportal</h4>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="row">
                        <div class="col-xl-12">
                            <div class="card">
                                <div class="card-body">
                                        <ul class="nav nav-tabs nav-justified nav-bordered mb-4" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <a href="#info" data-bs-toggle="tab" aria-expanded="true" class="nav-link active" aria-selected="false" role="tab">
                                                    <i class="mdi mdi-home-variant d-md-none d-block"></i>
                                                    <span class="d-none d-md-block h4">Info</span>
                                                </a>
                                            </li>
                                            {% if vertrieb_ticket.status == "angenommen" %}
                                            <li hidden class="nav-item" role="presentation">
                                                <a href="#ticket" data-bs-toggle="tab" aria-expanded="true" class="nav-link" aria-selected="false" tabindex="-1" role="tab">
                                                    <i class="mdi mdi-altimeter d-md-none d-block"></i>
                                                    <span class="d-none d-md-block h4">Ticket</span>
                                                </a>
                                            </li>
                                            {% endif %}
                                        </ul>
                                    <div class="tab-content">
                                        <div class="tab-pane show active" id="info" role="presentation">
                                            <div class="card-body">
                                                <div class="row">
                                                    <!-- Column 1 -->
                                                    <div class="col-lg-5">
                                                        <div class="card mb-3">
                                                        <div class="card-header bg-primary p-2 text-white bg-opacity-75 bg-gradient text-white">Interessenteninfo</div>
                                                            <div class="card-body">
                                                                <table class="table table-sm table-hover">
                                                                    <tbody>
                                                                        <tr hidden>
                                                                            <th></th>
                                                                            <td hidden>
                                                                                <div class="custom-control custom-switch">
                                                                                    <input type="checkbox" class="custom-control-input" id="switch10" {% if form.is_locked.value %}checked{% endif %} data-switch="success" name="{{ form.is_locked.html_name }}"/>
                                                                                    <label class="custom-control-label" for="switch10" data-on-label="Yes" data-off-label="No"></label>
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                        <tr hidden>
                                                                            <th>{{ form.zoho_id.label_tag }}</th>
                                                                            <td>{{ form.zoho_id }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.name.label_tag }}</th>
                                                                            <td><input type="text" class="form-control" name="{{ form.name.name }}" value="{{ form.name.value }}" readonly></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.anrede.label_tag }}</th>
                                                                            <td><input type="text" class="form-control" name="{{ form.anrede.name }}" value="{{ form.anrede.value }}" readonly></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.vorname_nachname.label_tag }}</th>
                                                                            <td><input type="text" class="form-control" name="{{ form.vorname_nachname.name }}" value="{{ form.vorname_nachname.value }}" readonly></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.telefon_mobil.label_tag }}</th>
                                                                            <td><input type="text" class="form-control" name="{{ form.telefon_mobil.name }}" value="{{ form.telefon_mobil.value }}" readonly></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.telefon_festnetz.label_tag }}</th>
                                                                            <td><input type="text" class="form-control" name="{{ form.telefon_festnetz.name }}" value="{{ form.telefon_festnetz.value }}" readonly></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.email.label_tag }}</th>
                                                                            <td><input type="text" class="form-control" name="{{ form.email.name }}" value="{{ form.email.value }}" readonly></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.firma.label_tag }}</th>
                                                                            <td><input type="text" class="form-control" name="{{ form.firma.name }}" value="{{ form.firma.value }}" readonly></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.strasse.label_tag }}</th>
                                                                            <td><input type="text" class="form-control" name="{{ form.strasse.name }}" value="{{ form.strasse.value }}" readonly></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.ort.label_tag }}</th>
                                                                            <td><input type="text" class="form-control" name="{{ form.ort.name }}" value="{{ form.ort.value }}" readonly></td>
                                                                        </tr>
                                                                        <tr>                                                                            
                                                                            <th>{{ form.postanschrift_name.label_tag }}</th>
                                                                            <td>{{ form.postanschrift_name }}</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <th>{{ form.postanschrift.label_tag }}</th>
                                                                            <td><input type="text" class="form-control" name="{{ form.postanschrift.name }}" value="{{ form.postanschrift.value }}" readonly></td>
                                                                            <td hidden>{{ form.postanschrift_latitude }}</td>
                                                                            <td hidden>{{ form.postanschrift_longitude }}</td>
                                                                        </tr>
                                                                        <tr>                                                                            
                                                                            <th>{{ form.postanschrift_ort.label_tag }}</th>
                                                                            <td>{{ form.postanschrift_ort }}</td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div><!-- End of row -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                <div class="row">
                        <div class="col-xxl-6">
                            <div class="row">
                                <div class="col-sm-6">
                                </div>
                                <div class="col-sm-6">
                                    <div class="card widget-flat">
                                        <div class="card-body border-info border">
                                            <h5 class="text-muted fw-normal mt-0">Kundennummer {{ vertrieb_ticket.zoho_kundennumer}}</h5>
                                            <h5 class="text-muted fw-normal mt-0" title="Number of Customers">Nachverkauf ID</h5>
                                            <h3 class="mt-3 mb-3">{{ vertrieb_ticket.ticket_id}}</h3>
                                            
                                            {% if vertrieb_ticket.countdown %}
                                            <span class="text-nowrap h4"> läuft in  </span><span class="text-danger me-2 text-nowrap h4">{{ vertrieb_ticket.countdown }}</span><span class="text-nowrap h4"> ab.</span>
                                            <p></p>
                                            {% endif %}
                                            <p class="mb-0 text-muted">
                                                {% if not vertrieb_ticket.is_locked %}
                                                    <span class="text-success me-2"></i> Verfügbar</span>
                                                {% else %}
                                                    <span class="text-danger me-2"></i> Nicht verfügbar</span>
                                                {% endif %}    
                                                    <span class="text-nowrap">Zugriff auf die Bearbeitung</span>  
                                            </p>
                                        </div> 
                                    </div> 
                                </div>
                            </div>
                        </div>
                        <div class="col-xxl-6">
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="card widget-flat">
                                        <div class="card-body border-info border">
                                            <h5 class="text-muted fw-normal mt-0" title="Number of Orders">Angenommenes Angebot</h5>
                                            <table class="table table-sm table-hover">
                                                <tbody>
                                                    <tr>
                                                        <th> Angebot ID</th>
                                                        <td>{{ vertrieb_ticket.angenommenes_angebot }}</td>
                                                    </tr>
                                                    <tr>
                                                        <th> Status PVA</th>
                                                        <td>{{ vertrieb_ticket.status_pva }}</td>
                                                    </tr>
                                                    <tr>
                                                        <th> Bauteile</th>
                                                        <td>{{ vertrieb_ticket.bauteile_finder|linebreaks }}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div> 
                                    </div> 
                                </div> 
                                <div class="col-sm-6">
                                    <div class="card widget-flat">
                                        <div class="card-body border-info border">
                                            <table class="table table-sm table-hover">
                                                <tr>
                                                    <th>Preis Netto</th>
                                                    <td class="text-success-emphasis">{{ vertrieb_ticket.angebotsumme|format_price }}</td>
                                                </tr>
                                                <tr>
                                                    <th>Preis Brutto</th>
                                                    <td class="text-success-emphasis">{{ vertrieb_ticket.kosten_pva|format_price }}</td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div><!-- End ROW -->
            </div> 
        </form>
       
{% endif %}
<input type="hidden" id="ajax-url" value="{% url 'vertrieb_interface:vertrieb_autofield' %}">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function() {
    var url = $("#ajax-url").val();
    // Cache selectors for efficiency
    var $anredeField = $("#id_anrede");
    var $firstNameField = $("#tr_first_name");
    var $lastNameLabel = $('label[for="id_nachname"]');
    var $nameField = $("#id_name");

    // Function to update form fields based on anredeField value
    function updateFormFields() {
        if ($anredeField.val() === 'Firma') {
            $firstNameField.prop('hidden', true);
            $lastNameLabel.text('Firma');
        } else if ($anredeField.val() === 'Familie') {
            $firstNameField.prop('hidden', true);
            $lastNameLabel.text('Nachname');
        } else {
            $firstNameField.prop('hidden', false);
            $lastNameLabel.text('Nachname');
        }
    }

    // Function to handle AJAX request for name field change
    function handleNameChange() {
        var name = $nameField.val();
        var url = "{% url 'vertrieb_interface:vertrieb_autofield' %}"; // Ensure the URL is correct and this script is processed by Django

        $.ajax({
            url: url,
            data: { 'name': name },
            success: function(data) {
                // Destructuring data for cleaner access
                const {
                    name,
                    name_first_name,
                    name_last_name,
                    zoho_id,
                    angenommenes_angebot,
                    anrede,
                    zoho_kundennumer,
                    strasse,
                    status_pva,
                    email,
                    telefon_mobil,
                    telefon_festnetz,
                    ort,
                    postanschrift,
                    postanschrift_name,
                    postanschrift_ort,
                    notizen,
                    anfrage_vom,
                    postanschrift_longitude: longitude,
                    postanschrift_latitude: latitude
                } = data;

                // Update fields with AJAX response data
                $("#id_vorname_nachname").val(name);
                $("#id_vorname").val(name_first_name);
                $("#id_nachname").val(name_last_name);
                $("#id_zoho_id").val(zoho_id);
                $("#id_angenommenes_angebot").val(angenommenes_angebot);
                $anredeField.val(anrede);
                $("#id_zoho_kundennumer").val(zoho_kundennumer);
                $("#id_strasse").val(strasse);
                $("#id_status_pva").val(status_pva);
                $("#id_email").val(email);
                $("#id_telefon_mobil").val(telefon_mobil);
                $("#id_telefon_festnetz").val(telefon_festnetz);
                $("#id_ort").val(ort);
                $("#id_postanschrift").val(postanschrift);
                $("#id_postanschrift_name").val(postanschrift_name);
                $("#id_postanschrift_ort").val(postanschrift_ort);
                $("#id_notizen").val(notizen);
                $("#id_angebot_bekommen_am").val(anfrage_vom);
                $("#longitude").val(longitude);
                $("#latitude").val(latitude);

                // Reflect any changes from AJAX response
                updateFormFields();
            },
            error: function(xhr, status, error) {
                console.error("AJAX Error:", error);
            }
        });
    }

    // Initial update of form fields based on the current value of anrede field
    updateFormFields();

    // Event listener for changes in the anrede field
    $anredeField.change(updateFormFields);

    // Event listener for changes in the name field to trigger AJAX
    $nameField.change(handleNameChange);
});
</script>

<script>

function submitFormWithAction(actionType) {
    document.getElementById('actionType').value = actionType;
    document.getElementById('main-form').submit();
}
</script>
            
        {% endif %}
        <footer class="footer">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-6">
                            <script>
                                    document.write(new Date().getFullYear())</script> © Juno-Solar Home 
                <script>        
                function getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }

                document.getElementById('send_support_message').addEventListener('click', function() {
                    var csrfToken = getCookie('csrftoken'); 
                    fetch('{% url 'vertrieb_interface:send_support_message' %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({})
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                        if (data.status === 'success') {
                            $('#success-alert-modal').modal('show');
                        }
                    });
                });
            </script>
    </div>
</div>

{% endblock %}    
{% block javascript %}
<script src="{% static 'assets/vendor/select2/js/select2.min.js' %}"></script>
<script>
$(document).ready(function() {
    // Function to handle tab actions
    function handleTabs() {
        // Get the previously active tab from local storage
        var activeTab = localStorage.getItem('activeTab');

        // If there's an active tab stored, activate it
        if (activeTab) {
            $('[href="' + activeTab + '"]').tab('show');
        }

        // When any tab is clicked, save it to the local storage
        $('.nav-tabs a').on('click', function() {
            var tabId = $(this).attr('href');
            localStorage.setItem('activeTab', tabId);
        });
    }

    // Check if the page is visible
    function isPageVisible() {
        return document.visibilityState === 'visible';
    }

    // Handle page visibility change
    document.addEventListener('visibilitychange', function() {
        if (isPageVisible()) {
            // If page is visible, handle tabs
            handleTabs();
        } else {
            // If page is not visible, unbind click event to stop saving tab state
            $('.nav-tabs a').off('click');
        }
    });

    // Initial tab handling
    if (isPageVisible()) {
        handleTabs();
    }
});
</script> 
<script>
    let arbeitsListe = JSON.parse('{{ vertrieb_ticket.Arbeits_liste|escapejs }}');
    let restListe = JSON.parse('{{ vertrieb_ticket.Rest_liste|escapejs }}');
    let zeitraum = {{ vertrieb_ticket.zeitraum }}
    ! function(n) {
        "use strict";
    
        function t() {
            this.charts = []
        }
        t.prototype.init = function() {
            this.initCharts()
        }, t.prototype.initCharts = function() {
            var t = ["#727cf5", "#0acf97"],
                e = n("#revenue-statistics-chart").data("colors"),
                e = {
                    chart: {
                        height: 531,
                        type: "line",
                        dropShadow: {
                            enabled: !0,
                            opacity: .4,
                            blur: 8,
                            left: -7,
                            top: 8
                        }
                    },
                    markers: {
                        size: 5,
                        strokeColors: undefined,
                        strokeWidth: 2,
                        strokeOpacity: 0.9,
                        fillOpacity: 1,
                        radius: 1,
                        customHTML: undefined,
                        onClick: undefined,
                        offsetX: 0,
                        offsetY: 0,
                        
                    },
                    dataLabels: {
                        enabled: !1,
                        formatter: undefined,
                        textAnchor: 'middle',
                        offsetX: 1,
                        offsetY: 0,
                        style: {
                            fontSize: '22px', // Increase this value to increase the font size
                            colors: undefined
                        },
                    },
                    stroke: {
                        curve: "straight",
                        width: 4
                    },
                    series: [{
                        name: "ohne PVA",
                        data: arbeitsListe,
                        style: {
                            fontSize: '18px', // Increase this value to increase the font size
                            
                        },
                    }, {
                        name: "mit PVA",
                        data: restListe
                    }],
                    colors: t = e ? e.split(",") : t,
                    zoom: {
                        enabled: !0
                    },
                    xaxis: {
                        title: {
                            text: "Jahre"
                        },
                        type: "string",
                        categories: Array.from({length: zeitraum}, (_, i) => i + 1),
                        tooltip: {
                            enabled: !1
                        },
                        axisBorder: {
                            show: !1
                        }
                    },
                    yaxis: {
                        title: {
                            text: "Kosten in €"
                        },
                        labels: {
                            formatter: function(t) {
                                return t.toFixed(2);
                            },
                            offsetX: -5
                        }
                    },
                    legend: {
                        show: true,
                        labels: {
                            colors: undefined,
                            useSeriesColors: false,
                            formatter: undefined,
                            fontSize: '20px', // Increase this value for a larger font size
                            fontFamily: undefined,
                            cssClass: undefined,
                        }
                    },

                };
            new ApexCharts(document.querySelector("#revenue-statistics-chart"), e).render()
        }, n.CrmManagement = new t, n.CrmManagement.Constructor = t
    }(window.jQuery),
    function(e) {
        "use strict";
        e(document).ready(function(t) {
            e.CrmManagement.init()
        })
    }(window.jQuery)
</script>
    

<script>
document.addEventListener("DOMContentLoaded", function() {
    
    const interessent = document.getElementById('id_name');
    const longitudeInput = document.getElementById('longitude');
    const latitudeInput = document.getElementById('latitude');
    var mapInitialized = false;
    var map, marker;
    var intervalId = null;

    function updateMapLink() {
        var lat = latitudeInput.value;
        var lon = longitudeInput.value;
        var link = document.getElementById('dynamicMapLink');
        if (lat && lon && link) {
            link.href = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}#map=14/${lat}/${lon}`;
        }
    }

    function initializeMap() {
        if (!mapInitialized && latitudeInput.value && longitudeInput.value) {
            document.getElementById('map').style.height = '550px';
            document.getElementById('map').style.width = '100%';

            map = L.map('map').setView([latitudeInput.value, longitudeInput.value], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            marker = L.marker([latitudeInput.value, longitudeInput.value]).addTo(map);
            mapInitialized = true;
        }
    }

    function pollForChanges() {
        var newLat = parseFloat(latitudeInput.value);
        var newLng = parseFloat(longitudeInput.value);
        var mapCenter = map.getCenter();

        // Calculate the difference between the map's center and the new coordinates
        var latDiff = Math.abs(mapCenter.lat - newLat);
        var lngDiff = Math.abs(mapCenter.lng - newLng);

        // Only update the map's view if the difference is significant (e.g., more than a small threshold)
        if ((latDiff > 0.0001 || lngDiff > 0.0001) && 
            (marker.getLatLng().lat !== newLat || marker.getLatLng().lng !== newLng)) {
            map.setView([newLat, newLng], map.getZoom());
            marker.setLatLng([newLat, newLng]);
        }
    }


    function startPollingInterval() {
        if (intervalId !== null) {
            clearInterval(intervalId);
        }
        intervalId = setInterval(pollForChanges, 3000);
    }

    interessent.addEventListener('input', pollForChanges);

    longitudeInput.addEventListener('change', updateMapLink);
    latitudeInput.addEventListener('change', updateMapLink);

    document.querySelector('a[href="#home-b1"]').addEventListener('shown.bs.tab', function(e) {
        updateMapLink();
        initializeMap();
    });
    

    initializeMap();
    setInterval(pollForChanges, 3000);
});
</script>
    
{% endblock %}

{% block extra_js %}
<script src="{% static 'assets/vendor/bootstrap-touchspin/jquery.bootstrap-touchspin.min.js' %}"></script>

<!-- Code Highlight js -->
<script src="{% static 'assets/vendor/highlightjs/highlight.pack.min.js' %}"></script>
<script src="{% static 'assets/vendor/clipboard/clipboard.min.js' %}"></script>
<script src="{% static 'assets/js/hyper-syntax.js' %}"></script>

<script src="{% static 'assets/vendor/apexcharts/apexcharts.min.js' %}"></script>
<script src="{% static 'assets/vendor/daterangepicker/moment.min.js' %}"></script>
        <!-- Chart.js-->
<script src="{% static 'assets/vendor/chart.js/chart.min.js' %}"></script>

        <!-- Chart.js Line Demo js -->
<script src="{% static 'assets/js/pages/demo.chartjs-line.js' %}"></script>  

<!-- Apex Chart Area Demo js -->
<script src="https://apexcharts.com/samples/assets/stock-prices.js"></script>
<script src="https://apexcharts.com/samples/assets/series1000.js"></script>
<script src="https://apexcharts.com/samples/assets/github-data.js"></script>
<script src="https://apexcharts.com/samples/assets/irregular-data-series.js"></script>
{% comment %} <script src="{% static 'assets/js/pages/demo.apex-area.js' %}"></script>   {% endcomment %}



<script src="{% static 'assets/vendor/dropzone/min/dropzone.min.js' %}"></script>
    <script src="{% static 'assets/vendor/jquery-mask-plugin/jquery.mask.min.js' %}"></script>

    <!-- Daterangepicker Plugin js -->
    <script src="{% static 'assets/vendor/daterangepicker/moment.min.js' %}"></script>
    <script src="{% static 'assets/vendor/daterangepicker/daterangepicker.js' %}"></script>

    <!-- Bootstrap Datepicker Plugin js -->
    <script src="{% static 'assets/vendor/bootstrap-datepicker/js/bootstrap-datepicker.min.js' %}"></script>

    <!-- Bootstrap Timepicker Plugin js -->
    <script src="{% static 'assets/vendor/bootstrap-timepicker/js/bootstrap-timepicker.min.js' %}"></script>

    <!-- Bootstrap Touchspin Plugin js -->
    <script src="{% static 'assets/vendor/bootstrap-touchspin/jquery.bootstrap-touchspin.min.js' %}"></script>

    <!-- Bootstrap Maxlength Plugin js -->
    <script src="{% static 'assets/vendor/bootstrap-maxlength/bootstrap-maxlength.min.js' %}"></script>

    <!-- Typehead Plugin js -->
    <script src="{% static 'assets/vendor/handlebars/handlebars.min.js' %}"></script>
    <script src="{% static 'assets/vendor/typeahead.js/typeahead.bundle.min.js' %}"></script>

    <!-- Flatpickr Timepicker Plugin js -->
    <script src="{% static 'assets/vendor/flatpickr/flatpickr.min.js' %}"></script>

    <!-- Demo js -->
    {% comment %} <script src="{% static 'assets/js/pages/demo.typehead.js' %}"></script> {% endcomment %}
    <script src="{% static 'assets/js/pages/demo.timepicker.js' %}"></script>

    <!-- Init js -->
    <script src="{% static 'assets/js/ui/component.fileupload.js' %}"></script>  
    <script src="{% static 'assets/js/vendor.min.js' %}"></script>
    <script src="{% static 'assets/vendor/highlightjs/highlight.pack.min.js' %}"></script>
    <script src="{% static 'assets/vendor/clipboard/clipboard.min.js' %}"></script>
    <script src="{% static 'assets/js/hyper-syntax.js' %}"></script>
    <script src="{% static 'assets/vendor/admin-resources/jquery.vectormap/jquery-jvectormap-1.2.2.min.js' %}"></script>
    <script src="{% static 'assets/vendor/admin-resources/jquery.vectormap/maps/jquery-jvectormap-world-mill-en.js' %}"></script>
    <script src="{% static 'assets/vendor/select2/js/select2.min.js' %}"></script>
    

        <!-- Apex Charts js -->
<script src="{% static 'assets/vendor/apexcharts/apexcharts.min.js' %}"></script>                                       
    <!-- Vector Map js -->
<script src="{% static 'assets/vendor/admin-resources/jquery.vectormap/jquery-jvectormap-1.2.2.min.js' %}"></script>
<script src="{% static 'assets/vendor/admin-resources/jquery.vectormap/maps/jquery-jvectormap-world-mill-en.js' %}"></script>

    <!-- App js -->
<script src="{% static 'assets/js/app.min.js' %}"></script>
{% endblock %}
 
</div>
                        <div class="col-md-6">
                            <div class="text-md-end footer-links d-none d-md-block">
                                <a type="submit" href="javascript:void(0)" id="send_support_message">Support</a>
                            </div>
                        </div>
                    </div>
                </div>
            </footer>
            <div class="d-print-none mt-4">
                <div class="text-end">
                    <div id="success-alert-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
                        <div class="modal-dialog modal-sm">
                            <div class="modal-content modal-filled bg-success">
                                <div class="modal-body p-4">
                                    <div class="text-center">
                                        <i class="ri-check-line h1"></i>
                                        <h4 class="mt-2">Erfolgreich!</h4>
                                        <p class="mt-3">Email support message wurde erfolgreich versendet!</p>
                                        <button type="button" class="btn btn-light my-2" data-bs-dismiss="modal">Weiter</button>
                                    </div>
                                </div>
                            </div><!-- /.modal-content -->
                        </div><!-- /.modal-dialog -->
                    </div>
                </div>
            </div>
            <script>